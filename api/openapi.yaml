openapi: 3.0.3
info:
  title: PaiBan æ’ç­å¼•æ“ API
  description: |
    PaiBan æ˜¯ä¸€ä¸ªé€šç”¨æ’ç­å¼•æ“æœåŠ¡ï¼Œæ”¯æŒé¤é¥®ã€å·¥å‚ã€å®¶æ”¿ã€é•¿æŠ¤é™©ç­‰å¤šç§åœºæ™¯çš„æ™ºèƒ½æ’ç­ã€‚
    
    ## åŠŸèƒ½ç‰¹ç‚¹
    - ğŸ”§ å¯é…ç½®çš„çº¦æŸç³»ç»Ÿï¼ˆç¡¬çº¦æŸ/è½¯çº¦æŸï¼‰
    - ğŸ¯ æ™ºèƒ½æ’ç­ç”Ÿæˆä¸ä¼˜åŒ–
    - âœ… æ’ç­å†²çªæ£€æµ‹ä¸éªŒè¯
    - ğŸ“Š å·¥ä½œé‡ç»Ÿè®¡ä¸å…¬å¹³æ€§åˆ†æ
    
    ## ä½¿ç”¨åœºæ™¯
    - **é¤é¥®é—¨åº—**: æ”¯æŒé«˜å³°æœŸæ’ç­ã€ä¸¤å¤´ç­ç­‰
    - **å·¥å‚äº§çº¿**: æ”¯æŒä¸‰ç­å€’ã€å€’ç­æ¨¡å¼
    - **å®¶æ”¿æœåŠ¡**: æ”¯æŒæ´¾å•ä¼˜åŒ–ã€è·¯çº¿è§„åˆ’
    - **é•¿æŠ¤é™©**: æ”¯æŒæŠ¤ç†è®¡åˆ’ã€æœåŠ¡è¿ç»­æ€§
  version: 1.0.0
  contact:
    name: PaiBan Team
  license:
    name: MIT

servers:
  - url: http://localhost:7012
    description: æœ¬åœ°å¼€å‘ç¯å¢ƒ
  - url: https://api.paiban.example.com
    description: ç”Ÿäº§ç¯å¢ƒ

tags:
  - name: System
    description: ç³»ç»ŸçŠ¶æ€ç›¸å…³æ¥å£
  - name: Schedule
    description: æ’ç­ç”Ÿæˆä¸ç®¡ç†
  - name: Constraints
    description: çº¦æŸé…ç½®ç®¡ç†
  - name: Dispatch
    description: æ´¾å•æœåŠ¡ï¼ˆå®¶æ”¿/é•¿æŠ¤é™©ï¼‰

paths:
  /health:
    get:
      tags: [System]
      summary: å¥åº·æ£€æŸ¥
      operationId: healthCheck
      responses:
        '200':
          description: æœåŠ¡æ­£å¸¸
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  service:
                    type: string
                    example: paiban

  /version:
    get:
      tags: [System]
      summary: è·å–ç‰ˆæœ¬ä¿¡æ¯
      operationId: getVersion
      responses:
        '200':
          description: ç‰ˆæœ¬ä¿¡æ¯
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VersionInfo'

  /api/v1/schedule/generate:
    post:
      tags: [Schedule]
      summary: ç”Ÿæˆæ’ç­
      description: |
        æ ¹æ®å‘˜å·¥ã€ç­æ¬¡å’Œéœ€æ±‚ç”Ÿæˆæ’ç­æ–¹æ¡ˆã€‚
        
        ç³»ç»Ÿä¼šï¼š
        1. éªŒè¯è¾“å…¥æ•°æ®
        2. åŠ è½½çº¦æŸé…ç½®
        3. ä½¿ç”¨è´ªå¿ƒç®—æ³•ç”Ÿæˆåˆå§‹æ–¹æ¡ˆ
        4. è¯„ä¼°çº¦æŸæ»¡è¶³åº¦
        5. è¿”å›æ’ç­ç»“æœ
      operationId: generateSchedule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateRequest'
            example:
              org_id: "550e8400-e29b-41d4-a716-446655440000"
              start_date: "2024-01-15"
              end_date: "2024-01-21"
              employees:
                - id: "550e8400-e29b-41d4-a716-446655440001"
                  name: "å¼ ä¸‰"
                  position: "æœåŠ¡å‘˜"
                  skills: ["æ”¶é“¶", "ç‚¹é¤"]
                - id: "550e8400-e29b-41d4-a716-446655440002"
                  name: "æå››"
                  position: "æœåŠ¡å‘˜"
                  skills: ["ç‚¹é¤"]
              shifts:
                - id: "550e8400-e29b-41d4-a716-446655440010"
                  name: "æ—©ç­"
                  code: "M"
                  start_time: "08:00"
                  end_time: "16:00"
                  duration: 480
              requirements:
                - shift_id: "550e8400-e29b-41d4-a716-446655440010"
                  date: "2024-01-15"
                  min_employees: 2
                  priority: 8
      responses:
        '200':
          description: æ’ç­ç”ŸæˆæˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerateResponse'
        '400':
          description: è¯·æ±‚å‚æ•°é”™è¯¯
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: æ— æ³•ç”Ÿæˆå¯è¡Œæ–¹æ¡ˆ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/schedule/validate:
    post:
      tags: [Schedule]
      summary: éªŒè¯æ’ç­
      description: éªŒè¯ç°æœ‰æ’ç­æ˜¯å¦æ»¡è¶³çº¦æŸæ¡ä»¶
      operationId: validateSchedule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateRequest'
      responses:
        '200':
          description: éªŒè¯ç»“æœ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidateResponse'
        '400':
          description: è¯·æ±‚å‚æ•°é”™è¯¯
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/constraints/templates:
    get:
      tags: [Constraints]
      summary: è·å–çº¦æŸæ¨¡æ¿åˆ—è¡¨
      description: è¿”å›å„åœºæ™¯çš„é¢„å®šä¹‰çº¦æŸæ¨¡æ¿
      operationId: getConstraintTemplates
      responses:
        '200':
          description: çº¦æŸæ¨¡æ¿åˆ—è¡¨
          content:
            application/json:
              schema:
                type: object
                properties:
                  templates:
                    type: array
                    items:
                      $ref: '#/components/schemas/ConstraintTemplate'

components:
  schemas:
    VersionInfo:
      type: object
      properties:
        version:
          type: string
          example: "1.0.0"
        build_time:
          type: string
          example: "2024-01-15T10:00:00Z"
        git_commit:
          type: string
          example: "abc1234"

    GenerateRequest:
      type: object
      required:
        - org_id
        - start_date
        - end_date
        - employees
        - shifts
        - requirements
      properties:
        org_id:
          type: string
          format: uuid
          description: ç»„ç»‡ID
        start_date:
          type: string
          format: date
          description: æ’ç­å¼€å§‹æ—¥æœŸ
        end_date:
          type: string
          format: date
          description: æ’ç­ç»“æŸæ—¥æœŸ
        scenario:
          type: string
          enum: [restaurant, factory, housekeeping, nursing]
          description: åœºæ™¯ç±»å‹ï¼ˆå¯é€‰ï¼Œç”¨äºåŠ è½½é¢„è®¾çº¦æŸï¼‰
        employees:
          type: array
          items:
            $ref: '#/components/schemas/EmployeeInput'
          description: å‚ä¸æ’ç­çš„å‘˜å·¥åˆ—è¡¨
        shifts:
          type: array
          items:
            $ref: '#/components/schemas/ShiftInput'
          description: å¯ç”¨ç­æ¬¡åˆ—è¡¨
        requirements:
          type: array
          items:
            $ref: '#/components/schemas/RequirementInput'
          description: æ’ç­éœ€æ±‚åˆ—è¡¨
        constraints:
          type: object
          additionalProperties: true
          description: è‡ªå®šä¹‰çº¦æŸé…ç½®
        options:
          $ref: '#/components/schemas/GenerateOptions'

    EmployeeInput:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        position:
          type: string
        skills:
          type: array
          items:
            type: string
        status:
          type: string
          enum: [active, inactive, leave]
          default: active

    ShiftInput:
      type: object
      required:
        - id
        - name
        - code
        - start_time
        - end_time
        - duration
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        code:
          type: string
        start_time:
          type: string
          pattern: '^([01]?[0-9]|2[0-3]):[0-5][0-9]$'
          example: "08:00"
        end_time:
          type: string
          pattern: '^([01]?[0-9]|2[0-3]):[0-5][0-9]$'
          example: "16:00"
        duration:
          type: integer
          description: ç­æ¬¡æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
        type:
          type: string
          enum: [morning, afternoon, evening, night, split]

    RequirementInput:
      type: object
      required:
        - shift_id
        - date
        - min_employees
      properties:
        shift_id:
          type: string
          format: uuid
        date:
          type: string
          format: date
        position:
          type: string
        min_employees:
          type: integer
          minimum: 1
        max_employees:
          type: integer
        opt_employees:
          type: integer
          description: æœ€ä¼˜äººæ•°
        skills:
          type: array
          items:
            type: string
        priority:
          type: integer
          minimum: 1
          maximum: 10
          default: 5

    GenerateOptions:
      type: object
      properties:
        timeout_seconds:
          type: integer
          default: 30
          description: è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
        optimization_level:
          type: integer
          enum: [1, 2, 3]
          default: 2
          description: ä¼˜åŒ–çº§åˆ«ï¼ˆ1=å¿«é€Ÿ, 2=å¹³è¡¡, 3=æœ€ä¼˜ï¼‰
        respect_preferences:
          type: boolean
          default: true
          description: æ˜¯å¦è€ƒè™‘å‘˜å·¥åå¥½

    GenerateResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        schedule_id:
          type: string
          format: uuid
        assignments:
          type: array
          items:
            $ref: '#/components/schemas/AssignmentOutput'
        statistics:
          $ref: '#/components/schemas/Statistics'
        constraint_result:
          $ref: '#/components/schemas/ConstraintResult'
        duration:
          type: string
          description: æ‰§è¡Œè€—æ—¶

    AssignmentOutput:
      type: object
      properties:
        id:
          type: string
          format: uuid
        employee_id:
          type: string
          format: uuid
        employee_name:
          type: string
        shift_id:
          type: string
          format: uuid
        shift_name:
          type: string
        date:
          type: string
          format: date
        start_time:
          type: string
        end_time:
          type: string
        position:
          type: string
        hours:
          type: number

    Statistics:
      type: object
      properties:
        total_assignments:
          type: integer
        filled_requirements:
          type: integer
        total_requirements:
          type: integer
        fill_rate:
          type: number
          description: éœ€æ±‚æ»¡è¶³ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
        total_hours:
          type: number
        avg_hours_per_employee:
          type: number
        iterations:
          type: integer

    ConstraintResult:
      type: object
      properties:
        is_valid:
          type: boolean
          description: æ˜¯å¦æ»¡è¶³æ‰€æœ‰ç¡¬çº¦æŸ
        score:
          type: number
          minimum: 0
          maximum: 100
          description: çº¦æŸæ»¡è¶³åº¦å¾—åˆ†
        hard_violations:
          type: array
          items:
            $ref: '#/components/schemas/ViolationDetail'
        soft_violations:
          type: array
          items:
            $ref: '#/components/schemas/ViolationDetail'

    ViolationDetail:
      type: object
      properties:
        constraint_type:
          type: string
        constraint_name:
          type: string
        employee_id:
          type: string
          format: uuid
        date:
          type: string
          format: date
        message:
          type: string
        severity:
          type: string
          enum: [error, warning]
        penalty:
          type: integer

    ValidateRequest:
      type: object
      required:
        - org_id
        - assignments
        - employees
      properties:
        org_id:
          type: string
          format: uuid
        assignments:
          type: array
          items:
            $ref: '#/components/schemas/AssignmentInput'
        employees:
          type: array
          items:
            $ref: '#/components/schemas/EmployeeInput'
        constraints:
          type: object
          additionalProperties: true

    AssignmentInput:
      type: object
      required:
        - employee_id
        - shift_id
        - date
        - start_time
        - end_time
      properties:
        employee_id:
          type: string
          format: uuid
        shift_id:
          type: string
          format: uuid
        date:
          type: string
          format: date
        start_time:
          type: string
        end_time:
          type: string
        position:
          type: string

    ValidateResponse:
      type: object
      properties:
        is_valid:
          type: boolean
        score:
          type: number
        violations:
          type: array
          items:
            $ref: '#/components/schemas/ViolationDetail'

    ConstraintTemplate:
      type: object
      properties:
        scenario:
          type: string
          enum: [restaurant, factory, housekeeping, nursing]
        name:
          type: string
        description:
          type: string

    ErrorResponse:
      type: object
      properties:
        error:
          type: boolean
          example: true
        code:
          type: string
          example: "VALIDATION_FAILED"
        message:
          type: string
          example: "éªŒè¯å¤±è´¥"
        details:
          type: string

  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

