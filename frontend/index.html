<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PaiBan æ’ç­å¼•æ“ API æµ‹è¯•æ§åˆ¶å°</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%234facfe'/><text x='50' y='65' font-size='50' font-weight='bold' fill='white' text-anchor='middle'>æ’</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-tertiary: #21262d;
      --bg-card: #1c2128;
      --border-primary: #30363d;
      --border-secondary: #484f58;
      --text-primary: #e6edf3;
      --text-secondary: #8b949e;
      --text-muted: #6e7681;
      --accent-cyan: #58a6ff;
      --accent-green: #3fb950;
      --accent-orange: #d29922;
      --accent-red: #f85149;
      --accent-purple: #a371f7;
      --accent-pink: #db61a2;
      --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.4);
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
    }

    body {
      font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      line-height: 1.6;
    }

    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-primary);
      padding: 1rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: var(--gradient-3);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
    }

    .logo-text {
      font-size: 1.5rem;
      font-weight: 700;
      background: var(--gradient-3);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .logo-subtitle { font-size: 0.75rem; color: var(--text-secondary); }

    .server-config { display: flex; align-items: center; gap: 1rem; }

    .server-input {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-sm);
      padding: 0.5rem 1rem;
      color: var(--text-primary);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.875rem;
      width: 280px;
    }

    .server-input:focus { outline: none; border-color: var(--accent-cyan); }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      font-size: 0.875rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-green);
      box-shadow: 0 0 8px var(--accent-green);
      animation: pulse 2s infinite;
    }

    .status-dot.offline { background: var(--accent-red); box-shadow: 0 0 8px var(--accent-red); }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .main {
      max-width: 1600px;
      margin: 0 auto;
      padding: 2rem;
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 2rem;
      flex: 1;
      min-height: 0;
      overflow: hidden;
      width: 100%;
      box-sizing: border-box;
    }

    .sidebar { display: flex; flex-direction: column; gap: 1.5rem; overflow: auto; min-height: 0; }

    .scenario-card {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .scenario-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .scenario-card.restaurant::before { background: var(--gradient-2); }
    .scenario-card.factory::before { background: var(--gradient-1); }
    .scenario-card.housekeeping::before { background: var(--gradient-4); }
    .scenario-card.nursing::before { background: var(--gradient-3); }

    .scenario-card:hover { border-color: var(--border-secondary); transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .scenario-card:hover::before, .scenario-card.active::before { opacity: 1; }
    .scenario-card.active { border-color: var(--accent-cyan); }

    .scenario-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; }

    .scenario-icon {
      width: 44px; height: 44px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .scenario-card.restaurant .scenario-icon { background: rgba(248, 81, 73, 0.15); }
    .scenario-card.factory .scenario-icon { background: rgba(163, 113, 247, 0.15); }
    .scenario-card.housekeeping .scenario-icon { background: rgba(63, 185, 80, 0.15); }
    .scenario-card.nursing .scenario-icon { background: rgba(88, 166, 255, 0.15); }

    .scenario-title { font-size: 1.1rem; font-weight: 600; }
    .scenario-subtitle { font-size: 0.75rem; color: var(--text-secondary); }
    .scenario-description { font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem; }

    .scenario-features { display: flex; flex-wrap: wrap; gap: 0.5rem; }

    .feature-tag {
      font-size: 0.7rem;
      padding: 0.25rem 0.5rem;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
    }

    .quick-actions {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
    }

    .quick-actions-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .quick-btn {
      width: 100%;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 0.875rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transition: all 0.2s;
    }

    .quick-btn:hover { background: var(--bg-secondary); border-color: var(--accent-cyan); }
    .quick-btn:last-child { margin-bottom: 0; }

    .content { display: flex; flex-direction: column; min-height: 0; overflow: hidden; }

    .panel {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .panel-header {
      background: var(--bg-secondary);
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-primary);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .panel-title { font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }

    .method-badge {
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      font-family: 'JetBrains Mono', monospace;
    }

    .method-badge.get { background: var(--accent-green); color: #000; }
    .method-badge.post { background: var(--accent-cyan); color: #000; }

    .panel-actions { display: flex; gap: 0.5rem; }

    .btn {
      padding: 0.5rem 1.25rem;
      border-radius: var(--radius-sm);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .btn-primary { background: var(--accent-cyan); color: #000; }
    .btn-primary:hover { background: #79b8ff; transform: translateY(-1px); }
    .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary); }
    .btn-secondary:hover { border-color: var(--accent-cyan); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .panel-body { padding: 1.5rem; }

    .code-editor {
      width: 100%;
      min-height: 200px;
      max-height: 350px;
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      padding: 1rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      line-height: 1.5;
      color: var(--text-primary);
      resize: vertical;
    }

    .code-editor:focus { outline: none; border-color: var(--accent-cyan); }

    .endpoint-display {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      margin-bottom: 1rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.875rem;
    }

    .endpoint-method { font-weight: 600; color: var(--accent-cyan); }
    .endpoint-path { color: var(--text-secondary); }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--border-primary);
      margin-bottom: 1rem;
    }

    .tab {
      padding: 0.75rem 1.25rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      margin-bottom: -1px;
      background: none;
      border-left: none;
      border-right: none;
      border-top: none;
    }

    .tab:hover { color: var(--text-primary); }
    .tab.active { color: var(--accent-cyan); border-bottom-color: var(--accent-cyan); }
    .tab-content { display: none; flex: 1; min-height: 0; }
    .tab-content.active { display: flex; flex-direction: column; }

    /* Main Panel Tabs */
    .main-panel { flex: 1; min-height: 0; display: flex; flex-direction: column; }
    .main-panel-header { flex-wrap: wrap; gap: 1rem; }
    
    .main-tabs {
      display: flex;
      gap: 0;
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      padding: 4px;
    }

    .main-tab {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 1.25rem;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      border: none;
      background: transparent;
      border-radius: var(--radius-sm);
      transition: all 0.2s;
      position: relative;
    }

    .main-tab:hover { color: var(--text-primary); background: var(--bg-secondary); }
    
    .main-tab.active {
      color: var(--text-primary);
      background: var(--bg-card);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .main-tab .status-badge {
      font-size: 0.75rem;
      padding: 0.15rem 0.4rem;
      border-radius: var(--radius-sm);
    }

    .main-tab .status-badge.waiting { background: var(--bg-secondary); color: var(--text-muted); }
    .main-tab .status-badge.success { background: var(--accent-green); color: #000; }
    .main-tab .status-badge.error { background: var(--accent-red); color: #fff; }

    .response-indicator {
      color: var(--accent-green);
      font-size: 0.6rem;
      animation: blink 1s infinite;
    }

    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

    .main-tab-content { display: none; flex: 1; min-height: 0; overflow: hidden; }
    .main-tab-content.active { display: flex; flex-direction: column; }
    .main-tab-content .panel-body { flex: 1; overflow: auto; display: flex; flex-direction: column; min-height: 0; }

    /* Business View Styles */
    .business-view, .request-biz-view {
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      padding: 1.5rem;
      flex: 1;
      overflow: auto;
    }

    .biz-section { margin-bottom: 1.5rem; }
    .biz-section:last-child { margin-bottom: 0; }

    .biz-section-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--accent-cyan);
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-primary);
    }

    .biz-message {
      padding: 1rem;
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .biz-message.success { border-left: 4px solid var(--accent-green); }
    .biz-message.partial { border-left: 4px solid var(--accent-orange); }
    .biz-message.error { border-left: 4px solid var(--accent-red); }

    /* Info Grid */
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.75rem;
    }

    .info-item {
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      padding: 0.75rem;
    }

    .info-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.25rem;
    }

    .info-value {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .info-value.cyan { color: var(--accent-cyan); }
    .info-value.green { color: var(--accent-green); }
    .info-value.orange { color: var(--accent-orange); }
    .info-value.purple { color: var(--accent-purple); }

    /* Employee/Shift/Requirement Cards */
    .item-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 0.75rem;
    }

    .item-card {
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      padding: 0.75rem;
      border-left: 3px solid var(--accent-cyan);
    }

    .item-card.shift { border-left-color: var(--accent-purple); }
    .item-card.requirement { border-left-color: var(--accent-orange); }
    .item-card.constraint { border-left-color: var(--accent-green); }

    .item-name {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    .item-detail {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .item-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      margin-top: 0.5rem;
    }

    .item-tag {
      font-size: 0.65rem;
      padding: 0.15rem 0.4rem;
      background: var(--bg-primary);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.75rem;
    }

    .stat-card {
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      padding: 1rem;
    }

    .stat-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 0.25rem;
    }

    .stat-value {
      font-size: 1.25rem;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
    }

    .stat-value.green { color: var(--accent-green); }
    .stat-value.cyan { color: var(--accent-cyan); }
    .stat-value.orange { color: var(--accent-orange); }
    .stat-value.purple { color: var(--accent-purple); }

    .stat-desc { font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.25rem; }

    /* Summary Cards */
    .results-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .summary-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      padding: 0.75rem;
      text-align: center;
    }

    .summary-value {
      font-size: 1.5rem;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
    }

    .summary-value.green { color: var(--accent-green); }
    .summary-value.cyan { color: var(--accent-cyan); }
    .summary-value.purple { color: var(--accent-purple); }
    .summary-value.orange { color: var(--accent-orange); }

    .summary-label { font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.25rem; }

    .response-meta {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 1rem;
    }

    .response-meta-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
    .response-meta-label { color: var(--text-secondary); }
    .response-meta-value { font-family: 'JetBrains Mono', monospace; font-weight: 500; }
    .response-meta-value.success { color: var(--accent-green); }
    .response-meta-value.error { color: var(--accent-red); }

    .response-output {
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      padding: 1rem;
      max-height: 400px;
      overflow: auto;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .response-placeholder {
      color: var(--text-muted);
      font-style: italic;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 150px;
      gap: 0.75rem;
    }

    .response-placeholder-icon { font-size: 2.5rem; opacity: 0.3; }

    /* Day groups */
    .day-group { margin-bottom: 1.25rem; }

    .day-header {
      font-weight: 600;
      color: var(--accent-purple);
      margin-bottom: 0.5rem;
      padding: 0.4rem 0;
      border-bottom: 1px dashed var(--border-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }

    .day-badge {
      font-size: 0.7rem;
      padding: 0.2rem 0.4rem;
      background: var(--accent-purple);
      color: white;
      border-radius: var(--radius-sm);
    }

    .assignment-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 0.75rem;
    }

    .assignment-card {
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      padding: 0.75rem;
      border-left: 3px solid var(--accent-cyan);
    }

    .assignment-emp { font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem; }
    .assignment-detail { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-secondary); }
    .assignment-shift { background: var(--bg-primary); padding: 0.2rem 0.4rem; border-radius: var(--radius-sm); }

    .constraint-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.75rem;
      border-radius: var(--radius-md);
      font-weight: 500;
      font-size: 0.875rem;
    }

    .constraint-badge.valid { background: rgba(63, 185, 80, 0.15); color: var(--accent-green); }
    .constraint-badge.invalid { background: rgba(248, 81, 73, 0.15); color: var(--accent-red); }

    /* çº¦æŸè¿è§„æ ·å¼ */
    .violations-container {
      background: rgba(248, 81, 73, 0.05);
      border: 1px solid rgba(248, 81, 73, 0.2);
      border-radius: var(--radius-md);
      padding: 1rem;
      margin-top: 0.5rem;
    }
    .violations-container.soft {
      background: rgba(210, 153, 34, 0.05);
      border-color: rgba(210, 153, 34, 0.2);
      margin-top: 1rem;
    }
    .violations-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid rgba(248, 81, 73, 0.15);
    }
    .violations-container.soft .violations-header {
      border-bottom-color: rgba(210, 153, 34, 0.15);
    }
    .violations-icon { font-size: 1.25rem; }
    .violations-title {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--accent-red);
    }
    .violations-container.soft .violations-title {
      color: var(--accent-orange);
    }
    .violations-list { display: flex; flex-direction: column; gap: 0.75rem; }

    .violation-group {
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }
    .violation-rule {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 0.75rem;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-primary);
    }
    .violation-rule-icon { font-size: 1rem; }
    .violation-rule-name {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--accent-cyan);
      flex: 1;
    }
    .violation-count {
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      background: rgba(248, 81, 73, 0.2);
      color: var(--accent-red);
      border-radius: var(--radius-sm);
      font-weight: 500;
    }

    .violation-items { padding: 0.5rem; }
    .violation-item {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.5rem 0.6rem;
      border-radius: var(--radius-sm);
      transition: background 0.15s;
    }
    .violation-item:hover { background: var(--bg-tertiary); }
    .violation-severity {
      flex-shrink: 0;
      font-size: 0.85rem;
    }
    .violation-message {
      flex: 1;
      font-size: 0.875rem;
      color: var(--text-primary);
      line-height: 1.5;
    }
    .violation-penalty {
      font-size: 0.75rem;
      padding: 0.15rem 0.4rem;
      background: rgba(248, 81, 73, 0.15);
      color: var(--accent-red);
      border-radius: var(--radius-sm);
      font-weight: 500;
      flex-shrink: 0;
    }
    .violation-item.soft .violation-penalty {
      background: rgba(210, 153, 34, 0.15);
      color: var(--accent-orange);
    }

    /* çº¦æŸæ¨¡æ¿æ ·å¼ */
    .template-card {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      margin-bottom: 1rem;
      overflow: hidden;
    }
    .template-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      cursor: pointer;
      transition: background 0.15s;
    }
    .template-header:hover { background: var(--bg-tertiary); }
    .template-icon {
      font-size: 2rem;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-primary);
      border-radius: var(--radius-md);
    }
    .template-info { flex: 1; }
    .template-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }
    .template-desc {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    .template-toggle {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .template-count {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
    }
    .template-arrow {
      color: var(--text-muted);
      font-size: 0.8rem;
      transition: transform 0.2s;
    }
    .template-body {
      border-top: 1px solid var(--border-primary);
      padding: 1rem;
      background: var(--bg-secondary);
    }

    .constraint-group {
      margin-bottom: 1rem;
    }
    .constraint-group:last-child { margin-bottom: 0; }
    .constraint-group-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .constraint-type-badge {
      padding: 0.25rem 0.6rem;
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 600;
    }
    .constraint-type-badge.hard {
      background: rgba(248, 81, 73, 0.15);
      color: var(--accent-red);
    }
    .constraint-type-badge.soft {
      background: rgba(163, 113, 247, 0.15);
      color: var(--accent-purple);
    }
    .constraint-group-desc {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .constraint-list {
      display: grid;
      gap: 0.5rem;
    }
    .constraint-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.6rem 0.75rem;
      background: var(--bg-card);
      border-radius: var(--radius-sm);
      border-left: 3px solid var(--accent-red);
    }
    .constraint-item.soft {
      border-left-color: var(--accent-purple);
    }
    .constraint-name {
      font-size: 0.9rem;
      color: var(--text-primary);
    }
    .constraint-meta {
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }
    .constraint-category {
      font-size: 0.75rem;
      padding: 0.15rem 0.4rem;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
    }
    .constraint-default {
      font-size: 0.8rem;
      color: var(--accent-cyan);
      font-weight: 500;
    }

    /* æ¨¡æ¿æ“ä½œæŒ‰é’® */
    .template-actions {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-primary);
    }
    .template-action-btn {
      padding: 0.5rem 1rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-primary);
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .template-action-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--border-secondary);
    }
    .template-action-btn.edit:hover {
      border-color: var(--accent-orange);
      color: var(--accent-orange);
    }
    .template-action-btn.apply:hover {
      border-color: var(--accent-green);
      color: var(--accent-green);
    }
    .template-action-btn.add:hover {
      border-color: var(--accent-purple);
      color: var(--accent-purple);
    }
    .template-action-btn.cancel {
      color: var(--accent-red);
      border-color: rgba(255, 85, 85, 0.3);
    }
    .template-action-btn.cancel:hover {
      border-color: var(--accent-red);
      background: rgba(255, 85, 85, 0.1);
    }

    /* çº¦æŸåº“æ ·å¼ */
    .library-category {
      margin-bottom: 1.5rem;
    }
    .library-category-header {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--accent-cyan);
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border-primary);
      margin-bottom: 0.75rem;
    }
    .library-constraints {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .library-item {
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      padding: 1rem;
      transition: all 0.2s;
    }
    .library-item:hover {
      border-color: var(--accent-cyan);
      background: var(--bg-tertiary);
    }
    .library-item.hard {
      border-left: 3px solid var(--accent-red);
    }
    .library-item.soft {
      border-left: 3px solid var(--accent-cyan);
    }
    .library-item-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
    }
    .library-item-name {
      font-weight: 600;
      color: var(--text-primary);
    }
    .library-item-code {
      font-size: 0.75rem;
      color: var(--text-muted);
      background: var(--bg-primary);
      padding: 0.2rem 0.5rem;
      border-radius: var(--radius-sm);
      font-family: 'JetBrains Mono', monospace;
    }
    .library-item-desc {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 0.75rem;
    }
    .library-item-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      justify-content: space-between;
    }
    .scenario-tags {
      display: flex;
      gap: 0.35rem;
      flex-wrap: wrap;
    }
    .scenario-tag {
      font-size: 0.7rem;
      color: var(--text-muted);
      background: var(--bg-primary);
      padding: 0.15rem 0.4rem;
      border-radius: var(--radius-sm);
    }
    .param-list {
      display: flex;
      gap: 0.35rem;
      flex-wrap: wrap;
    }
    .param-badge {
      font-size: 0.7rem;
      color: var(--accent-purple);
      background: rgba(189, 147, 249, 0.1);
      padding: 0.15rem 0.4rem;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(189, 147, 249, 0.3);
    }

    /* åˆ é™¤çº¦æŸæŒ‰é’® */
    .constraint-delete-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.85rem;
      padding: 0.25rem;
      opacity: 0;
      transition: all 0.2s;
    }
    .constraint-item:hover .constraint-delete-btn {
      opacity: 1;
    }
    .constraint-delete-btn:hover {
      color: var(--accent-red);
    }

    /* çº¦æŸåº“æ¨¡æ€æ¡† */
    .library-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .library-modal-content {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }
    .library-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border-primary);
      font-weight: 600;
      color: var(--accent-cyan);
    }
    .library-modal-close {
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 1.25rem;
      cursor: pointer;
      padding: 0.25rem;
    }
    .library-modal-close:hover {
      color: var(--accent-red);
    }
    .library-modal-body {
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .library-select-item {
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .library-select-item:hover {
      border-color: var(--accent-cyan);
      background: var(--bg-tertiary);
    }
    .library-select-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .library-select-name {
      font-weight: 600;
      color: var(--text-primary);
    }
    .library-select-desc {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }
    .library-select-params {
      display: flex;
      gap: 0.35rem;
      flex-wrap: wrap;
    }

    /* æ–°å¢çº¦æŸè¡¨å• */
    .add-constraint-form {
      background: var(--bg-primary);
      border: 1px solid var(--accent-purple);
      border-radius: var(--radius-md);
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .form-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--accent-purple);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-primary);
    }
    .form-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }
    .form-row label {
      width: 80px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      flex-shrink: 0;
    }
    .form-input, .form-select {
      flex: 1;
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-sm);
      padding: 0.5rem 0.75rem;
      color: var(--text-primary);
      font-size: 0.85rem;
      font-family: inherit;
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--accent-purple);
    }
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-primary);
    }
    .form-btn {
      padding: 0.5rem 1.25rem;
      border-radius: var(--radius-sm);
      border: none;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.15s;
    }
    .form-btn.cancel {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }
    .form-btn.cancel:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }
    .form-btn.submit {
      background: var(--accent-purple);
      color: white;
    }
    .form-btn.submit:hover {
      opacity: 0.9;
    }

    /* çº¦æŸå€¼è¾“å…¥æ¡† */
    .constraint-input {
      background: var(--bg-primary);
      border: 1px solid var(--accent-cyan);
      border-radius: var(--radius-sm);
      padding: 0.25rem 0.5rem;
      color: var(--accent-cyan);
      font-size: 0.8rem;
      width: 120px;
      font-family: 'JetBrains Mono', monospace;
    }
    .constraint-input:focus {
      outline: none;
      border-color: var(--accent-purple);
      box-shadow: 0 0 0 2px rgba(163, 113, 247, 0.2);
    }

    /* Toast æç¤º */
    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-card);
      border: 1px solid var(--accent-green);
      border-radius: var(--radius-md);
      padding: 0.75rem 1.5rem;
      color: var(--text-primary);
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 1000;
      opacity: 0;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-lg);
    }
    .toast.error {
      border-color: var(--accent-red);
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .json-key { color: #79c0ff; }
    .json-string { color: #a5d6ff; }
    .json-number { color: #56d364; }
    .json-boolean { color: #ff7b72; }
    .json-null { color: #8b949e; }

    @media (max-width: 1200px) {
      .main { grid-template-columns: 1fr; }
      .sidebar { flex-direction: row; flex-wrap: wrap; }
      .scenario-card { flex: 1; min-width: 250px; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon">æ’</div>
        <div>
          <div class="logo-text">PaiBan Engine</div>
          <div class="logo-subtitle">æ™ºèƒ½æ’ç­å¼•æ“ API æµ‹è¯•æ§åˆ¶å°</div>
        </div>
      </div>
      <div class="server-config">
        <input type="text" class="server-input" id="serverUrl" value="http://localhost:7012" placeholder="API æœåŠ¡å™¨åœ°å€">
        <div class="status-indicator">
          <div class="status-dot" id="statusDot"></div>
          <span id="statusText">æ£€æµ‹ä¸­...</span>
        </div>
      </div>
    </div>
  </header>

  <main class="main">
    <aside class="sidebar">
      <div class="scenario-card restaurant active" data-scenario="restaurant">
        <div class="scenario-header">
          <div class="scenario-icon">ğŸœ</div>
          <div>
            <div class="scenario-title">é¤é¥®é—¨åº—</div>
            <div class="scenario-subtitle">Restaurant</div>
          </div>
        </div>
        <p class="scenario-description">æ”¯æŒé«˜å³°æœŸæ’ç­ã€ä¸¤å¤´ç­ã€æŠ€èƒ½åŒ¹é…ç­‰é¤é¥®è¡Œä¸šç‰¹æ®Šéœ€æ±‚ã€‚</p>
        <div class="scenario-features">
          <span class="feature-tag">é«˜å³°æœŸæ’ç­</span>
          <span class="feature-tag">ä¸¤å¤´ç­</span>
          <span class="feature-tag">æŠ€èƒ½åŒ¹é…</span>
        </div>
      </div>

      <div class="scenario-card factory" data-scenario="factory">
        <div class="scenario-header">
          <div class="scenario-icon">ğŸ­</div>
          <div>
            <div class="scenario-title">å·¥å‚äº§çº¿</div>
            <div class="scenario-subtitle">Factory</div>
          </div>
        </div>
        <p class="scenario-description">æ”¯æŒä¸‰ç­å€’ã€å€’ç­æ¨¡å¼ã€è¿ç»­ç”Ÿäº§ç­‰åˆ¶é€ ä¸šåœºæ™¯ã€‚</p>
        <div class="scenario-features">
          <span class="feature-tag">ä¸‰ç­å€’</span>
          <span class="feature-tag">å€’ç­æ¨¡å¼</span>
          <span class="feature-tag">äº§çº¿è¦†ç›–</span>
        </div>
      </div>

      <div class="scenario-card housekeeping" data-scenario="housekeeping">
        <div class="scenario-header">
          <div class="scenario-icon">ğŸ </div>
          <div>
            <div class="scenario-title">å®¶æ”¿æœåŠ¡</div>
            <div class="scenario-subtitle">Housekeeping</div>
          </div>
        </div>
        <p class="scenario-description">æ”¯æŒæ´¾å•ä¼˜åŒ–ã€è·¯çº¿è§„åˆ’ã€æœåŠ¡æ—¶é—´çª—å£ç­‰å®¶æ”¿ç‰¹è‰²åŠŸèƒ½ã€‚</p>
        <div class="scenario-features">
          <span class="feature-tag">æ´¾å•ä¼˜åŒ–</span>
          <span class="feature-tag">è·¯çº¿è§„åˆ’</span>
          <span class="feature-tag">æ—¶é—´çª—å£</span>
        </div>
      </div>

      <div class="scenario-card nursing" data-scenario="nursing">
        <div class="scenario-header">
          <div class="scenario-icon">ğŸ’Š</div>
          <div>
            <div class="scenario-title">é•¿æŠ¤é™©/æŠ¤ç†</div>
            <div class="scenario-subtitle">Nursing Care</div>
          </div>
        </div>
        <p class="scenario-description">æ”¯æŒæŠ¤ç†è®¡åˆ’ã€æœåŠ¡è¿ç»­æ€§ã€èµ„è´¨åŒ¹é…ç­‰åŒ»ç–—æŠ¤ç†éœ€æ±‚ã€‚</p>
        <div class="scenario-features">
          <span class="feature-tag">æŠ¤ç†è®¡åˆ’</span>
          <span class="feature-tag">è¿ç»­æ€§ä¿éšœ</span>
          <span class="feature-tag">èµ„è´¨åŒ¹é…</span>
        </div>
      </div>

      <div class="quick-actions">
        <div class="quick-actions-title">å¿«æ·æ“ä½œ</div>
        <button class="quick-btn" onclick="checkHealth()"><span>ğŸ’“</span><span>å¥åº·æ£€æŸ¥</span></button>
        <button class="quick-btn" onclick="getVersion()"><span>ğŸ“‹</span><span>ç‰ˆæœ¬ä¿¡æ¯</span></button>
        <button class="quick-btn" onclick="getConstraintTemplates()"><span>ğŸ“</span><span>çº¦æŸæ¨¡æ¿</span></button>
        <button class="quick-btn" onclick="getConstraintLibrary()"><span>ğŸ“š</span><span>çº¦æŸåº“</span></button>
        <button class="quick-btn" onclick="clearResponse()"><span>ğŸ—‘ï¸</span><span>æ¸…ç©ºå“åº”</span></button>
      </div>
    </aside>

    <section class="content">
      <!-- Unified Panel with Main Tabs -->
      <div class="panel main-panel">
        <div class="panel-header main-panel-header">
          <!-- Main Tabs for Request/Response -->
          <div class="main-tabs">
            <button class="main-tab active" data-main-tab="request" onclick="switchMainTab('request')">
              <span class="method-badge post" id="requestMethod">POST</span>
              <span>ğŸ“ è¯·æ±‚é…ç½®</span>
            </button>
            <button class="main-tab" data-main-tab="response" onclick="switchMainTab('response')">
              <span id="responseStatusBadge" class="status-badge waiting">â³</span>
              <span>ğŸ“Š å“åº”ç»“æœ</span>
              <span class="response-indicator" id="responseIndicator" style="display: none;">â—</span>
            </button>
          </div>
          <div class="panel-actions">
            <button class="btn btn-secondary" onclick="formatRequest()">æ ¼å¼åŒ–</button>
            <button class="btn btn-secondary" onclick="resetRequest()">é‡ç½®</button>
            <button class="btn btn-secondary" onclick="copyResponse()">ğŸ“‹ å¤åˆ¶</button>
            <button class="btn btn-primary" id="sendBtn" onclick="sendRequest()">ğŸš€ å‘é€è¯·æ±‚</button>
          </div>
        </div>

        <!-- Request Content -->
        <div class="main-tab-content active" id="requestContent">
          <div class="panel-body">
            <div class="endpoint-display">
              <span class="endpoint-method" id="endpointMethod">POST</span>
              <span class="endpoint-path" id="endpointPath">/api/v1/schedule/generate</span>
            </div>

            <!-- Request Sub-Tabs -->
            <div class="tabs">
              <button class="tab active" data-tab="reqBiz" onclick="switchRequestTab('reqBiz')">ğŸ“‹ ä¸šåŠ¡é…ç½®</button>
              <button class="tab" data-tab="reqJson" onclick="switchRequestTab('reqJson')">{ } JSON é…ç½®</button>
            </div>

            <!-- Request Business View -->
            <div class="tab-content active" id="reqBizTab">
              <div class="request-biz-view" id="requestBizView"></div>
            </div>

            <!-- Request JSON Tab -->
            <div class="tab-content" id="reqJsonTab">
              <textarea class="code-editor" id="requestBody" spellcheck="false"></textarea>
            </div>
          </div>
        </div>

        <!-- Response Content -->
        <div class="main-tab-content" id="responseContent">
          <div class="panel-body">
            <div class="response-meta" id="responseMeta" style="display: none;">
              <div class="response-meta-item">
                <span class="response-meta-label">çŠ¶æ€:</span>
                <span class="response-meta-value" id="responseStatus">-</span>
              </div>
              <div class="response-meta-item">
                <span class="response-meta-label">è€—æ—¶:</span>
                <span class="response-meta-value" id="responseTime">-</span>
              </div>
              <div class="response-meta-item">
                <span class="response-meta-label">å¤§å°:</span>
                <span class="response-meta-value" id="responseSize">-</span>
              </div>
            </div>

            <div id="resultsSummary" class="results-summary" style="display: none;">
              <div class="summary-card">
                <div class="summary-value green" id="summaryAssignments">0</div>
                <div class="summary-label">æ’ç­æ•°</div>
              </div>
              <div class="summary-card">
                <div class="summary-value cyan" id="summaryFillRate">0%</div>
                <div class="summary-label">æ»¡è¶³ç‡</div>
              </div>
              <div class="summary-card">
                <div class="summary-value purple" id="summaryScore">0</div>
                <div class="summary-label">çº¦æŸå¾—åˆ†</div>
              </div>
              <div class="summary-card">
                <div class="summary-value orange" id="summaryDuration">-</div>
                <div class="summary-label">è®¡ç®—è€—æ—¶</div>
              </div>
            </div>

            <div class="tabs" id="responseTabs" style="display: none;">
              <button class="tab active" data-tab="resBiz" onclick="switchResponseTab('resBiz')">ğŸ“Š ä¸šåŠ¡è§†å›¾</button>
              <button class="tab" data-tab="resJson" onclick="switchResponseTab('resJson')">{ } JSON æ•°æ®</button>
            </div>

            <div class="tab-content active" id="resBizTab">
              <div class="business-view" id="businessView">
                <div class="response-placeholder">
                  <div class="response-placeholder-icon">ğŸ“¡</div>
                  <span>é€‰æ‹©åœºæ™¯å¹¶å‘é€è¯·æ±‚ä»¥æŸ¥çœ‹å“åº”</span>
                </div>
              </div>
            </div>

            <div class="tab-content" id="resJsonTab">
              <div class="response-output" id="responseOutput"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const scenarioMeta = {
      restaurant: { icon: 'ğŸœ', name: 'é¤é¥®é—¨åº—', color: '#f85149' },
      factory: { icon: 'ğŸ­', name: 'å·¥å‚äº§çº¿', color: '#a371f7' },
      housekeeping: { icon: 'ğŸ ', name: 'å®¶æ”¿æœåŠ¡', color: '#3fb950' },
      nursing: { icon: 'ğŸ’Š', name: 'é•¿æŠ¤é™©/æŠ¤ç†', color: '#58a6ff' }
    };

    const scenarioData = {
      restaurant: {
        method: 'POST',
        endpoint: '/api/v1/schedule/generate',
        body: {
          org_id: "550e8400-e29b-41d4-a716-446655440000",
          start_date: getTodayDate(),
          end_date: getNextWeekDate(),
          scenario: "restaurant",
          employees: [
            // æœåŠ¡å‘˜å›¢é˜Ÿï¼ˆ6äººï¼‰- æ—©ç­æ™šç­å„éœ€2äºº
            { id: "550e8400-e29b-41d4-a716-446655440001", name: "å¼ ä¸‰", position: "æœåŠ¡å‘˜", skills: ["æ”¶é“¶", "ç‚¹é¤", "ä¼ èœ"], status: "active" },
            { id: "550e8400-e29b-41d4-a716-446655440002", name: "æå››", position: "æœåŠ¡å‘˜", skills: ["ç‚¹é¤", "ä¼ èœ"], status: "active" },
            { id: "550e8400-e29b-41d4-a716-446655440005", name: "é’±ä¸ƒ", position: "æœåŠ¡å‘˜", skills: ["æ”¶é“¶"], status: "active" },
            { id: "550e8400-e29b-41d4-a716-446655440006", name: "å­™å…«", position: "æœåŠ¡å‘˜", skills: ["ç‚¹é¤", "ä¼ èœ"], status: "active" },
            { id: "550e8400-e29b-41d4-a716-446655440007", name: "å‘¨ä¹", position: "æœåŠ¡å‘˜", skills: ["æ”¶é“¶", "ç‚¹é¤"], status: "active" },
            { id: "550e8400-e29b-41d4-a716-446655440008", name: "å´å", position: "æœåŠ¡å‘˜", skills: ["ä¼ èœ"], status: "active" },
            // å¨å¸ˆå›¢é˜Ÿï¼ˆ3äººï¼‰- æ—©ç­æ™šç­å„éœ€1äºº
            { id: "550e8400-e29b-41d4-a716-446655440003", name: "ç‹äº”", position: "å¨å¸ˆ", skills: ["ç‚’èœ", "å‡‰èœ"], status: "active" },
            { id: "550e8400-e29b-41d4-a716-446655440004", name: "èµµå…­", position: "å¨å¸ˆ", skills: ["ç‚’èœ", "é¢ç‚¹"], status: "active" },
            { id: "550e8400-e29b-41d4-a716-446655440009", name: "éƒ‘åä¸€", position: "å¨å¸ˆ", skills: ["ç‚’èœ", "å‡‰èœ", "é¢ç‚¹"], status: "active" }
          ],
          shifts: [
            { id: "550e8400-e29b-41d4-a716-446655440010", name: "æ—©ç­", code: "M", start_time: "09:00", end_time: "14:00", duration: 300, type: "morning" },
            { id: "550e8400-e29b-41d4-a716-446655440011", name: "åˆç­", code: "A", start_time: "11:00", end_time: "14:00", duration: 180, type: "afternoon" },
            { id: "550e8400-e29b-41d4-a716-446655440012", name: "æ™šç­", code: "E", start_time: "17:00", end_time: "22:00", duration: 300, type: "evening" },
            { id: "550e8400-e29b-41d4-a716-446655440013", name: "ä¸¤å¤´ç­", code: "S", start_time: "11:00", end_time: "21:00", duration: 480, type: "split" }
          ],
          requirements: generateRestaurantRequirements(),
          constraints: { max_hours_per_week: 44, min_rest_hours: 11, max_consecutive_days: 6 },
          options: { timeout_seconds: 30, optimization_level: 2, respect_preferences: true }
        }
      },
      factory: {
        method: 'POST',
        endpoint: '/api/v1/schedule/generate',
        body: {
          org_id: "650e8400-e29b-41d4-a716-446655440000",
          start_date: getTodayDate(),
          end_date: getNextWeekDate(),
          scenario: "factory",
          employees: [
            { id: "650e8400-e29b-41d4-a716-446655440001", name: "å·¥äººA", position: "æ“ä½œå·¥", skills: ["æ•°æ§è½¦åºŠ", "ç„Šæ¥"], status: "active" },
            { id: "650e8400-e29b-41d4-a716-446655440002", name: "å·¥äººB", position: "æ“ä½œå·¥", skills: ["æ•°æ§è½¦åºŠ"], status: "active" },
            { id: "650e8400-e29b-41d4-a716-446655440003", name: "å·¥äººC", position: "æ“ä½œå·¥", skills: ["ç„Šæ¥", "è£…é…"], status: "active" },
            { id: "650e8400-e29b-41d4-a716-446655440004", name: "å·¥äººD", position: "è´¨æ£€å‘˜", skills: ["è´¨é‡æ£€éªŒ"], status: "active" },
            { id: "650e8400-e29b-41d4-a716-446655440005", name: "å·¥äººE", position: "æ“ä½œå·¥", skills: ["è£…é…"], status: "active" },
            { id: "650e8400-e29b-41d4-a716-446655440006", name: "å·¥äººF", position: "æ“ä½œå·¥", skills: ["æ•°æ§è½¦åºŠ", "è£…é…"], status: "active" }
          ],
          shifts: [
            { id: "650e8400-e29b-41d4-a716-446655440010", name: "ç™½ç­", code: "D", start_time: "08:00", end_time: "16:00", duration: 480, type: "morning" },
            { id: "650e8400-e29b-41d4-a716-446655440011", name: "ä¸­ç­", code: "S", start_time: "16:00", end_time: "00:00", duration: 480, type: "afternoon" },
            { id: "650e8400-e29b-41d4-a716-446655440012", name: "å¤œç­", code: "N", start_time: "00:00", end_time: "08:00", duration: 480, type: "night" }
          ],
          requirements: generateFactoryRequirements(),
          constraints: { max_hours_per_week: 48, min_rest_hours: 8, max_consecutive_nights: 3 },
          options: { timeout_seconds: 30, optimization_level: 2 }
        }
      },
      housekeeping: {
        method: 'POST',
        endpoint: '/api/v1/schedule/generate',
        body: {
          org_id: "750e8400-e29b-41d4-a716-446655440000",
          start_date: getTodayDate(),
          end_date: getNextWeekDate(),
          scenario: "housekeeping",
          employees: [
            { id: "750e8400-e29b-41d4-a716-446655440001", name: "é˜¿å§¨A", position: "ä¿æ´å‘˜", skills: ["æ—¥å¸¸ä¿æ´", "å¼€è’ä¿æ´"], status: "active" },
            { id: "750e8400-e29b-41d4-a716-446655440002", name: "é˜¿å§¨B", position: "ä¿æ´å‘˜", skills: ["æ—¥å¸¸ä¿æ´", "æ“¦ç»ç’ƒ"], status: "active" },
            { id: "750e8400-e29b-41d4-a716-446655440003", name: "é˜¿å§¨C", position: "æœˆå«‚", skills: ["æœˆå«‚æœåŠ¡", "è‚²å„¿å«‚"], status: "active" },
            { id: "750e8400-e29b-41d4-a716-446655440004", name: "é˜¿å§¨D", position: "ä¿æ´å‘˜", skills: ["æ—¥å¸¸ä¿æ´"], status: "active" }
          ],
          shifts: [
            { id: "750e8400-e29b-41d4-a716-446655440010", name: "ä¸Šåˆæ—¶æ®µ", code: "AM", start_time: "08:00", end_time: "12:00", duration: 240, type: "morning" },
            { id: "750e8400-e29b-41d4-a716-446655440011", name: "ä¸‹åˆæ—¶æ®µ", code: "PM", start_time: "14:00", end_time: "18:00", duration: 240, type: "afternoon" },
            { id: "750e8400-e29b-41d4-a716-446655440012", name: "å…¨å¤©æœåŠ¡", code: "FD", start_time: "08:00", end_time: "18:00", duration: 480, type: "morning" }
          ],
          requirements: generateHousekeepingRequirements(),
          constraints: { max_orders_per_day: 3, skill_match_required: true },
          options: { timeout_seconds: 30, respect_preferences: true }
        }
      },
      nursing: {
        method: 'POST',
        endpoint: '/api/v1/schedule/generate',
        body: {
          org_id: "850e8400-e29b-41d4-a716-446655440000",
          start_date: getTodayDate(),
          end_date: getNextWeekDate(),
          scenario: "nursing",
          employees: [
            { id: "850e8400-e29b-41d4-a716-446655440001", name: "æŠ¤ç†å‘˜A", position: "æŠ¤ç†å‘˜", skills: ["åŸºç¡€æŠ¤ç†", "åº·å¤æŠ¤ç†"], status: "active" },
            { id: "850e8400-e29b-41d4-a716-446655440002", name: "æŠ¤ç†å‘˜B", position: "æŠ¤ç†å‘˜", skills: ["åŸºç¡€æŠ¤ç†", "ç”Ÿæ´»ç…§æ–™"], status: "active" },
            { id: "850e8400-e29b-41d4-a716-446655440003", name: "æŠ¤ç†å‘˜C", position: "é«˜çº§æŠ¤ç†å‘˜", skills: ["åº·å¤æŠ¤ç†", "åŸºç¡€æŠ¤ç†"], status: "active" },
            { id: "850e8400-e29b-41d4-a716-446655440004", name: "æŠ¤ç†å‘˜D", position: "æŠ¤ç†å‘˜", skills: ["ç”Ÿæ´»ç…§æ–™", "åŸºç¡€æŠ¤ç†"], status: "active" }
          ],
          shifts: [
            { id: "850e8400-e29b-41d4-a716-446655440010", name: "ä¸ŠåˆæŠ¤ç†", code: "AM", start_time: "08:00", end_time: "12:00", duration: 240, type: "morning" },
            { id: "850e8400-e29b-41d4-a716-446655440011", name: "ä¸‹åˆæŠ¤ç†", code: "PM", start_time: "14:00", end_time: "18:00", duration: 240, type: "afternoon" },
            { id: "850e8400-e29b-41d4-a716-446655440012", name: "å…¨æ—¥æŠ¤ç†", code: "FD", start_time: "08:00", end_time: "17:00", duration: 480, type: "morning" }
          ],
          requirements: generateNursingRequirements(),
          constraints: { continuity_required: true, max_patients_per_day: 4 },
          options: { timeout_seconds: 30, optimization_level: 3 }
        }
      }
    };

    function getTodayDate() { return new Date().toISOString().split('T')[0]; }
    function getNextWeekDate() { const d = new Date(); d.setDate(d.getDate() + 7); return d.toISOString().split('T')[0]; }
    function getDateOffset(days) { const d = new Date(); d.setDate(d.getDate() + days); return d.toISOString().split('T')[0]; }
    // é¤é¥®é—¨åº—ï¼šåˆç†æ’ç­éœ€æ±‚ï¼ˆè€ƒè™‘10å°æ—¶ç­æ¬¡é—´ä¼‘æ¯çº¦æŸï¼Œå‘˜å·¥æ¯å¤©åªä¸Šä¸€ä¸ªç­æ¬¡ï¼‰
    function generateRestaurantRequirements() {
      const morningShift = "550e8400-e29b-41d4-a716-446655440010";  // æ—©ç­ 9:00-14:00
      const eveningShift = "550e8400-e29b-41d4-a716-446655440012";  // æ™šç­ 17:00-22:00
      
      const reqs = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date(); d.setDate(d.getDate() + i);
        const dayOfWeek = d.getDay();
        const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
        
        // æœåŠ¡å‘˜æ—©ç­ï¼šæ¯å¤©2äºº
        reqs.push({ shift_id: morningShift, date: getDateOffset(i), position: "æœåŠ¡å‘˜", min_employees: 2, priority: 8, note: "æ—©ç­æœåŠ¡" });
        // æœåŠ¡å‘˜æ™šç­ï¼šæ¯å¤©2äººï¼ˆå‘¨æœ«éœ€è¦3äººï¼‰
        reqs.push({ shift_id: eveningShift, date: getDateOffset(i), position: "æœåŠ¡å‘˜", min_employees: isWeekend ? 3 : 2, priority: 8, note: isWeekend ? "å‘¨æœ«æ™šç­" : "æ™šç­æœåŠ¡" });
        // å¨å¸ˆæ—©ç­ï¼šæ¯å¤©1äºº
        reqs.push({ shift_id: morningShift, date: getDateOffset(i), position: "å¨å¸ˆ", min_employees: 1, priority: 9, note: "æ—©ç­å¤‡é¤" });
        // å¨å¸ˆæ™šç­ï¼šæ¯å¤©1äºº
        reqs.push({ shift_id: eveningShift, date: getDateOffset(i), position: "å¨å¸ˆ", min_employees: 1, priority: 9, note: "æ™šç­å¤‡é¤" });
      }
      return reqs;
    }
    function generateFactoryRequirements() {
      const shifts = ["650e8400-e29b-41d4-a716-446655440010", "650e8400-e29b-41d4-a716-446655440011", "650e8400-e29b-41d4-a716-446655440012"];
      const names = ["ç™½ç­", "ä¸­ç­", "å¤œç­"];
      return Array.from({length: 7}, (_, i) => shifts.map((s, idx) => ({ shift_id: s, date: getDateOffset(i), min_employees: 2, priority: 9, note: names[idx] + "äº§çº¿" }))).flat();
    }
    function generateHousekeepingRequirements() {
      const reqs = [];
      for (let i = 0; i < 7; i++) {
        reqs.push({ shift_id: "750e8400-e29b-41d4-a716-446655440010", date: getDateOffset(i), position: "ä¿æ´å‘˜", min_employees: 2, priority: 7, note: "æ—¥å¸¸ä¿æ´è®¢å•" });
        if (i % 2 === 0) {
          reqs.push({ shift_id: "750e8400-e29b-41d4-a716-446655440011", date: getDateOffset(i), position: "ä¿æ´å‘˜", min_employees: 1, priority: 6, note: "ä¸‹åˆä¿æ´" });
        }
      }
      return reqs;
    }
    function generateNursingRequirements() {
      const reqs = [];
      for (let i = 0; i < 7; i++) {
        reqs.push({ shift_id: "850e8400-e29b-41d4-a716-446655440010", date: getDateOffset(i), position: "æŠ¤ç†å‘˜", min_employees: 2, priority: 10, note: "ä¸ŠåˆæŠ¤ç†" });
        reqs.push({ shift_id: "850e8400-e29b-41d4-a716-446655440011", date: getDateOffset(i), position: "æŠ¤ç†å‘˜", min_employees: 2, priority: 10, note: "ä¸‹åˆæŠ¤ç†" });
      }
      return reqs;
    }

    let currentScenario = 'restaurant';
    let isLoading = false;
    let lastResponse = null;

    const serverUrlInput = document.getElementById('serverUrl');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const requestBody = document.getElementById('requestBody');
    const requestBizView = document.getElementById('requestBizView');
    const responseMeta = document.getElementById('responseMeta');
    const resultsSummary = document.getElementById('resultsSummary');
    const responseTabs = document.getElementById('responseTabs');
    const businessView = document.getElementById('businessView');
    const responseOutput = document.getElementById('responseOutput');
    const sendBtn = document.getElementById('sendBtn');

    document.querySelectorAll('.scenario-card').forEach(card => {
      card.addEventListener('click', () => selectScenario(card.dataset.scenario));
    });

    loadScenario('restaurant');
    checkServerStatus();
    setInterval(checkServerStatus, 30000);

    function selectScenario(scenario) {
      currentScenario = scenario;
      document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('active'));
      document.querySelector(`.scenario-card.${scenario}`).classList.add('active');
      loadScenario(scenario);
    }

    function loadScenario(scenario) {
      const data = scenarioData[scenario];
      document.getElementById('requestMethod').textContent = data.method;
      document.getElementById('requestMethod').className = `method-badge ${data.method.toLowerCase()}`;
      document.getElementById('endpointMethod').textContent = data.method;
      document.getElementById('endpointPath').textContent = data.endpoint;
      requestBody.value = JSON.stringify(data.body, null, 2);
      renderRequestBizView(data.body, scenario);
    }

    function renderRequestBizView(body, scenario) {
      const meta = scenarioMeta[scenario];
      const weekDays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];

      let html = `
        <div class="biz-section">
          <div class="biz-section-title">ğŸ“Œ åŸºæœ¬ä¿¡æ¯</div>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">åœºæ™¯ç±»å‹</div>
              <div class="info-value" style="color: ${meta.color}">${meta.icon} ${meta.name}</div>
            </div>
            <div class="info-item">
              <div class="info-label">å¼€å§‹æ—¥æœŸ</div>
              <div class="info-value cyan">${body.start_date}</div>
            </div>
            <div class="info-item">
              <div class="info-label">ç»“æŸæ—¥æœŸ</div>
              <div class="info-value cyan">${body.end_date}</div>
            </div>
            <div class="info-item">
              <div class="info-label">æ’ç­å‘¨æœŸ</div>
              <div class="info-value green">${daysBetween(body.start_date, body.end_date)} å¤©</div>
            </div>
          </div>
        </div>

        <div class="biz-section">
          <div class="biz-section-title">ğŸ‘¥ å‚ä¸å‘˜å·¥ (${body.employees.length} äºº)</div>
          <div class="item-grid">
            ${body.employees.map(e => `
              <div class="item-card">
                <div class="item-name">ğŸ‘¤ ${e.name}</div>
                <div class="item-detail">${e.position || 'å‘˜å·¥'}</div>
                ${e.skills?.length ? `<div class="item-tags">${e.skills.map(s => `<span class="item-tag">${s}</span>`).join('')}</div>` : ''}
              </div>
            `).join('')}
          </div>
        </div>

        <div class="biz-section">
          <div class="biz-section-title">ğŸ• ç­æ¬¡è®¾ç½® (${body.shifts.length} ä¸ª)</div>
          <div class="item-grid">
            ${body.shifts.map(s => `
              <div class="item-card shift">
                <div class="item-name">ğŸ“… ${s.name}</div>
                <div class="item-detail">${s.start_time} - ${s.end_time} (${Math.round(s.duration/60)}h)</div>
                <div class="item-tags"><span class="item-tag">${s.code}</span></div>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="biz-section">
          <div class="biz-section-title">ğŸ“‹ æ’ç­éœ€æ±‚ (${body.requirements.length} æ¡)</div>
          <div class="item-grid">
            ${body.requirements.slice(0, 12).map(r => {
              const d = new Date(r.date);
              const shift = body.shifts?.find(s => s.id === r.shift_id);
              const shiftName = shift ? shift.name : '';
              return `
                <div class="item-card requirement">
                  <div class="item-name">${weekDays[d.getDay()]} ${r.date}</div>
                  <div class="item-detail">${r.note || shiftName || 'ç­æ¬¡'}: ${r.min_employees} äºº${r.position ? ` (${r.position})` : ''}</div>
                  <div class="item-tags">
                    ${shiftName ? `<span class="item-tag">${shiftName}</span>` : ''}
                    <span class="item-tag">ä¼˜å…ˆçº§ ${r.priority || 5}</span>
                  </div>
                </div>
              `;
            }).join('')}
            ${body.requirements.length > 12 ? `<div class="item-card requirement" style="text-align: center; border-left-color: var(--text-muted);"><div class="item-detail">... è¿˜æœ‰ ${body.requirements.length - 12} æ¡éœ€æ±‚</div></div>` : ''}
          </div>
        </div>

        <div class="biz-section">
          <div class="biz-section-title">âš™ï¸ çº¦æŸè§„åˆ™</div>
          <div class="item-grid">
            ${Object.entries(body.constraints || {}).map(([k, v]) => `
              <div class="item-card constraint">
                <div class="item-name">${constraintLabel(k)}</div>
                <div class="item-detail" style="color: var(--accent-green); font-weight: 600;">${formatConstraintValue(k, v)}</div>
              </div>
            `).join('')}
          </div>
        </div>

        ${body.options ? `
        <div class="biz-section">
          <div class="biz-section-title">ğŸ›ï¸ è®¡ç®—é€‰é¡¹</div>
          <div class="info-grid">
            ${body.options.timeout_seconds ? `<div class="info-item"><div class="info-label">è¶…æ—¶æ—¶é—´</div><div class="info-value">${body.options.timeout_seconds} ç§’</div></div>` : ''}
            ${body.options.optimization_level ? `<div class="info-item"><div class="info-label">ä¼˜åŒ–çº§åˆ«</div><div class="info-value">${['', 'å¿«é€Ÿ', 'å¹³è¡¡', 'æœ€ä¼˜'][body.options.optimization_level]}</div></div>` : ''}
            ${body.options.respect_preferences !== undefined ? `<div class="info-item"><div class="info-label">è€ƒè™‘åå¥½</div><div class="info-value">${body.options.respect_preferences ? 'æ˜¯' : 'å¦'}</div></div>` : ''}
          </div>
        </div>
        ` : ''}
      `;

      requestBizView.innerHTML = html;
    }

    function constraintLabel(key) {
      const labels = {
        max_hours_per_week: 'æœ€å¤§å‘¨å·¥æ—¶',
        min_rest_hours: 'æœ€å°ä¼‘æ¯æ—¶é—´',
        max_consecutive_days: 'æœ€å¤§è¿ç»­å·¥ä½œå¤©æ•°',
        max_consecutive_nights: 'æœ€å¤§è¿ç»­å¤œç­',
        max_orders_per_day: 'æ¯æ—¥æœ€å¤§è®¢å•',
        skill_match_required: 'æŠ€èƒ½åŒ¹é…',
        continuity_required: 'æœåŠ¡è¿ç»­æ€§',
        max_patients_per_day: 'æ¯æ—¥æœ€å¤§æ‚£è€…æ•°',
        rotation_pattern: 'å€’ç­æ¨¡å¼'
      };
      return labels[key] || key;
    }

    function formatConstraintValue(key, value) {
      if (typeof value === 'boolean') return value ? 'å¿…é¡»' : 'ä¸è¦æ±‚';
      if (key.includes('hours')) return `${value} å°æ—¶`;
      if (key.includes('days')) return `${value} å¤©`;
      return value;
    }

    function daysBetween(start, end) {
      const s = new Date(start);
      const e = new Date(end);
      return Math.ceil((e - s) / (1000 * 60 * 60 * 24)) + 1;
    }

    function switchMainTab(tabName) {
      // Update main tab buttons
      document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.main-tab[data-main-tab="${tabName}"]`)?.classList.add('active');
      
      // Update main tab content
      document.querySelectorAll('.main-tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(tabName + 'Content')?.classList.add('active');
    }

    function switchRequestTab(tabName) {
      document.querySelectorAll('#requestContent .tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('#requestContent .tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector(`#requestContent .tab[data-tab="${tabName}"]`)?.classList.add('active');
      document.getElementById(tabName + 'Tab')?.classList.add('active');

      // Sync JSON when switching to JSON tab
      if (tabName === 'reqJson') {
        try { JSON.parse(requestBody.value); } catch(e) { /* keep existing */ }
      }
    }

    function switchResponseTab(tabName) {
      document.querySelectorAll('#responseTabs .tab').forEach(t => t.classList.remove('active'));
      document.getElementById('resBizTab').classList.remove('active');
      document.getElementById('resJsonTab').classList.remove('active');
      document.querySelector(`#responseTabs .tab[data-tab="${tabName}"]`)?.classList.add('active');
      document.getElementById(tabName + 'Tab')?.classList.add('active');
    }

    async function checkServerStatus() {
      const url = serverUrlInput.value;
      try {
        const response = await fetch(`${url}/health`);
        if (response.ok) { statusDot.classList.remove('offline'); statusText.textContent = 'æœåŠ¡æ­£å¸¸'; }
        else throw new Error();
      } catch (e) { statusDot.classList.add('offline'); statusText.textContent = 'æ— æ³•è¿æ¥'; }
    }

    async function sendRequest() {
      if (isLoading) return;
      const url = serverUrlInput.value;
      const data = scenarioData[currentScenario];

      let body;
      try { body = JSON.parse(requestBody.value); }
      catch (e) { showError('JSON æ ¼å¼é”™è¯¯: ' + e.message); return; }

      isLoading = true;
      sendBtn.disabled = true;
      sendBtn.innerHTML = 'â³ è¯·æ±‚ä¸­...';

      const startTime = performance.now();

      try {
        const response = await fetch(`${url}${data.endpoint}`, {
          method: data.method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const responseData = await response.json();
        lastResponse = responseData;
        showResponse(response.status, performance.now() - startTime, responseData);
      } catch (e) { showError('è¯·æ±‚å¤±è´¥: ' + e.message); }
      finally {
        isLoading = false;
        sendBtn.disabled = false;
        sendBtn.innerHTML = 'ğŸš€ å‘é€è¯·æ±‚';
      }
    }

    function showResponse(status, time, data) {
      // Auto switch to response tab
      switchMainTab('response');
      
      // Update status badge on main tab
      const statusBadge = document.getElementById('responseStatusBadge');
      const indicator = document.getElementById('responseIndicator');
      if (status >= 200 && status < 300) {
        statusBadge.className = 'status-badge success';
        statusBadge.textContent = 'âœ“';
        indicator.style.display = 'inline';
      } else {
        statusBadge.className = 'status-badge error';
        statusBadge.textContent = 'âœ—';
        indicator.style.display = 'none';
      }

      responseMeta.style.display = 'flex';
      const statusEl = document.getElementById('responseStatus');
      statusEl.textContent = status;
      statusEl.className = 'response-meta-value ' + (status >= 200 && status < 300 ? 'success' : 'error');
      document.getElementById('responseTime').textContent = time.toFixed(0) + 'ms';
      document.getElementById('responseSize').textContent = formatBytes(JSON.stringify(data).length);

      if (data.assignments !== undefined) {
        resultsSummary.style.display = 'grid';
        responseTabs.style.display = 'flex';
        document.getElementById('summaryAssignments').textContent = data.assignments?.length || 0;
        document.getElementById('summaryFillRate').textContent = (data.statistics?.fill_rate?.toFixed(1) || '0') + '%';
        document.getElementById('summaryScore').textContent = data.constraint_result?.score?.toFixed(1) || '0';
        document.getElementById('summaryDuration').textContent = data.duration || '-';
        renderResponseBizView(data);
      } else {
        resultsSummary.style.display = 'none';
        responseTabs.style.display = 'none';
        businessView.innerHTML = renderGenericBizView(data);
      }

      responseOutput.innerHTML = syntaxHighlight(JSON.stringify(data, null, 2));
      switchResponseTab('resBiz');
    }

    function renderResponseBizView(data) {
      const weekDays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
      const msgClass = data.success ? (data.partial ? 'partial' : 'success') : 'error';
      const msgIcon = data.success ? (data.partial ? 'âš ï¸' : 'âœ…') : 'âŒ';

      let html = `
        <div class="biz-section">
          <div class="biz-message ${msgClass}">
            <span style="font-size: 1.5rem;">${msgIcon}</span>
            <span>${data.message || (data.success ? 'æ’ç­ç”ŸæˆæˆåŠŸ' : 'æ’ç­å¤±è´¥')}</span>
          </div>
        </div>
      `;

      if (data.statistics) {
        const s = data.statistics;
        html += `
          <div class="biz-section">
            <div class="biz-section-title">ğŸ“ˆ ç»Ÿè®¡æ‘˜è¦</div>
            <div class="stats-grid">
              <div class="stat-card"><div class="stat-label">æ€»æ’ç­æ•°</div><div class="stat-value green">${s.total_assignments || 0}</div><div class="stat-desc">å·²å®‰æ’çš„ç­æ¬¡</div></div>
              <div class="stat-card"><div class="stat-label">éœ€æ±‚æ»¡è¶³</div><div class="stat-value cyan">${s.filled_requirements || 0} / ${s.total_requirements || 0}</div><div class="stat-desc">æ»¡è¶³ç‡ ${(s.fill_rate || 0).toFixed(1)}%</div></div>
              <div class="stat-card"><div class="stat-label">æ€»å·¥æ—¶</div><div class="stat-value orange">${s.total_hours || 0}h</div><div class="stat-desc">äººå‡ ${(s.avg_hours_per_employee || 0).toFixed(1)}h</div></div>
              <div class="stat-card"><div class="stat-label">è¿­ä»£æ¬¡æ•°</div><div class="stat-value purple">${s.iterations || 0}</div><div class="stat-desc">ç®—æ³•è½®æ¬¡</div></div>
            </div>
          </div>
        `;
      }

      if (data.constraint_result) {
        const cr = data.constraint_result;
        html += `
          <div class="biz-section">
            <div class="biz-section-title">âœ… çº¦æŸæ£€æŸ¥</div>
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
              <div class="constraint-badge ${cr.is_valid ? 'valid' : 'invalid'}">${cr.is_valid ? 'âœ“ æ‰€æœ‰ç¡¬çº¦æŸæ»¡è¶³' : 'âœ— å­˜åœ¨çº¦æŸè¿è§„'}</div>
              <span style="color: var(--text-secondary);">å¾—åˆ†: <strong style="color: var(--accent-cyan);">${(cr.score || 0).toFixed(1)}</strong>/100</span>
            </div>
        `;
        
        // æ˜¾ç¤ºç¡¬çº¦æŸè¿è§„è¯¦æƒ…
        if (cr.hard_violations && cr.hard_violations.length > 0) {
          html += `
            <div class="violations-container">
              <div class="violations-header">
                <span class="violations-icon">âš ï¸</span>
                <span class="violations-title">ç¡¬çº¦æŸè¿è§„è¯¦æƒ… (${cr.hard_violations.length}é¡¹)</span>
              </div>
              <div class="violations-list">
          `;
          
          // æŒ‰çº¦æŸç±»å‹åˆ†ç»„
          const byType = {};
          cr.hard_violations.forEach(v => {
            const type = v.constraint_name || v.constraint_type;
            if (!byType[type]) byType[type] = [];
            byType[type].push(v);
          });
          
          Object.keys(byType).forEach(type => {
            const violations = byType[type];
            html += `
              <div class="violation-group">
                <div class="violation-rule">
                  <span class="violation-rule-icon">ğŸ“‹</span>
                  <span class="violation-rule-name">${type}</span>
                  <span class="violation-count">${violations.length}é¡¹è¿è§„</span>
                </div>
                <div class="violation-items">
            `;
            
            violations.forEach(v => {
              html += `
                <div class="violation-item">
                  <span class="violation-severity ${v.severity === 'error' ? 'error' : 'warning'}">
                    ${v.severity === 'error' ? 'âŒ' : 'âš ï¸'}
                  </span>
                  <span class="violation-message">${v.message}</span>
                  <span class="violation-penalty">-${v.penalty}åˆ†</span>
                </div>
              `;
            });
            
            html += `</div></div>`;
          });
          
          html += `</div></div>`;
        }
        
        // æ˜¾ç¤ºè½¯çº¦æŸè¿è§„ï¼ˆå¦‚æœæœ‰ï¼‰
        if (cr.soft_violations && cr.soft_violations.length > 0) {
          html += `
            <div class="violations-container soft">
              <div class="violations-header">
                <span class="violations-icon">ğŸ’¡</span>
                <span class="violations-title">è½¯çº¦æŸæé†’ (${cr.soft_violations.length}é¡¹)</span>
              </div>
              <div class="violations-list">
          `;
          
          cr.soft_violations.forEach(v => {
            html += `
              <div class="violation-item soft">
                <span class="violation-severity warning">ğŸ’¡</span>
                <span class="violation-message">${v.message}</span>
                <span class="violation-penalty">-${v.penalty}åˆ†</span>
              </div>
            `;
          });
          
          html += `</div></div>`;
        }
        
        html += `</div>`;
      }

      if (data.assignments?.length) {
        const byDay = {};
        data.assignments.forEach(a => { if (!byDay[a.date]) byDay[a.date] = []; byDay[a.date].push(a); });

        html += `<div class="biz-section"><div class="biz-section-title">ğŸ“‹ æ’ç­è¯¦æƒ…</div>`;
        Object.keys(byDay).sort().forEach(date => {
          const d = new Date(date);
          html += `
            <div class="day-group">
              <div class="day-header"><span class="day-badge">${weekDays[d.getDay()]}</span><span>${date}</span><span style="color: var(--text-muted);">(${byDay[date].length}ä¸ª)</span></div>
              <div class="assignment-cards">
                ${byDay[date].map(a => `
                  <div class="assignment-card">
                    <div class="assignment-emp">ğŸ‘¤ ${a.employee_name}</div>
                    <div class="assignment-detail"><span class="assignment-shift">${a.shift_name}</span><span>${a.start_time}-${a.end_time}</span><span style="color:var(--accent-green)">${a.hours}h</span></div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        });
        html += '</div>';
      }

      businessView.innerHTML = html;
    }

    function renderGenericBizView(data) {
      if (data.status === 'ok') return `<div class="biz-section"><div class="biz-message success"><span style="font-size:1.5rem">âœ…</span><span>æœåŠ¡æ­£å¸¸è¿è¡Œ</span></div></div>`;
      if (data.templates) return renderConstraintTemplates(data.templates);
      if (data.library) return renderConstraintLibrary(data.library);
      if (data.version) return `<div class="biz-section"><div class="biz-section-title">ğŸ“‹ ç‰ˆæœ¬</div><div class="info-grid"><div class="info-item"><div class="info-label">ç‰ˆæœ¬</div><div class="info-value cyan">${data.version}</div></div></div></div>`;
      return `<div style="text-align: center; padding: 2rem; color: var(--text-muted);">ğŸ’¡ è¯·åˆ‡æ¢åˆ° JSON æŸ¥çœ‹è¯¦æƒ…</div>`;
    }

    // å­˜å‚¨æ¨¡æ¿æ•°æ®ç”¨äºç¼–è¾‘
    let constraintTemplatesData = [];

    function renderConstraintTemplates(templates) {
      constraintTemplatesData = JSON.parse(JSON.stringify(templates)); // æ·±æ‹·è´
      
      let html = `<div class="biz-section"><div class="biz-section-title">ğŸ“ çº¦æŸæ¨¡æ¿åˆ—è¡¨ (${templates.length}ä¸ªåœºæ™¯)</div>`;
      
      templates.forEach((t, idx) => {
        const scenarioIcons = {restaurant: 'ğŸœ', factory: 'ğŸ­', housekeeping: 'ğŸ ', nursing: 'ğŸ’Š'};
        const icon = scenarioIcons[t.scenario] || 'ğŸ“‹';
        
        // æŒ‰ç±»å‹åˆ†ç»„çº¦æŸ
        const hardConstraints = (t.constraints || []).filter(c => c.type === 'hard');
        const softConstraints = (t.constraints || []).filter(c => c.type === 'soft');
        
        html += `
          <div class="template-card" id="template-${idx}">
            <div class="template-header" onclick="toggleTemplate(${idx})">
              <div class="template-icon">${icon}</div>
              <div class="template-info">
                <div class="template-name">${t.name}</div>
                <div class="template-desc">${t.description}</div>
              </div>
              <div class="template-toggle">
                <span class="template-count">${(t.constraints || []).length} æ¡çº¦æŸ</span>
                <span class="template-arrow" id="arrow-${idx}">â–¼</span>
              </div>
            </div>
            <div class="template-body" id="body-${idx}" style="display: none;">
              <div class="template-actions">
                <button class="template-action-btn edit" onclick="event.stopPropagation(); toggleEditMode(${idx})">
                  <span id="editIcon-${idx}">âœï¸</span> <span id="editText-${idx}">ç¼–è¾‘</span>
                </button>
                <button class="template-action-btn cancel" id="cancelBtn-${idx}" style="display: none;" onclick="event.stopPropagation(); cancelEditMode(${idx})">
                  âŒ å–æ¶ˆ
                </button>
                <button class="template-action-btn add" onclick="event.stopPropagation(); showAddFromLibrary(${idx}, '${t.scenario}')">
                  ğŸ“š ä»çº¦æŸåº“æ·»åŠ 
                </button>
                <button class="template-action-btn apply" onclick="event.stopPropagation(); applyTemplate('${t.scenario}', ${idx})">
                  âœ… åº”ç”¨åˆ°å½“å‰é…ç½®
                </button>
              </div>
              <div class="add-constraint-form" id="addForm-${idx}" style="display: none;">
                <div class="form-title">â• æ–°å¢çº¦æŸæ¡ä»¶</div>
                <div class="form-row">
                  <label>çº¦æŸç±»å‹</label>
                  <select id="newType-${idx}" class="form-select">
                    <option value="hard">ç¡¬çº¦æŸï¼ˆå¿…é¡»æ»¡è¶³ï¼‰</option>
                    <option value="soft">è½¯çº¦æŸï¼ˆå°½é‡æ»¡è¶³ï¼‰</option>
                  </select>
                </div>
                <div class="form-row">
                  <label>çº¦æŸåç§°</label>
                  <input type="text" id="newName-${idx}" class="form-input" placeholder="å¦‚: custom_rule_1">
                </div>
                <div class="form-row">
                  <label>çº¦æŸæè¿°</label>
                  <input type="text" id="newDesc-${idx}" class="form-input" placeholder="å¦‚: è‡ªå®šä¹‰è§„åˆ™æè¿°">
                </div>
                <div class="form-row">
                  <label>çº¦æŸåˆ†ç±»</label>
                  <input type="text" id="newCategory-${idx}" class="form-input" placeholder="å¦‚: å·¥æ—¶é™åˆ¶">
                </div>
                <div class="form-row">
                  <label>é»˜è®¤å€¼</label>
                  <input type="text" id="newDefault-${idx}" class="form-input" placeholder="å¦‚: 8å°æ—¶">
                </div>
                <div class="form-actions">
                  <button class="form-btn cancel" onclick="hideAddConstraintForm(${idx})">å–æ¶ˆ</button>
                  <button class="form-btn submit" onclick="addNewConstraint(${idx})">æ·»åŠ </button>
                </div>
              </div>
        `;
        
        if (hardConstraints.length > 0) {
          html += `
            <div class="constraint-group">
              <div class="constraint-group-title">
                <span class="constraint-type-badge hard">ç¡¬çº¦æŸ</span>
                <span class="constraint-group-desc">å¿…é¡»æ»¡è¶³ï¼Œè¿åå°†å¯¼è‡´æ’ç­æ— æ•ˆ</span>
              </div>
              <div class="constraint-list">
          `;
          hardConstraints.forEach((c, cIdx) => {
            const fullIdx = `${idx}-hard-${cIdx}`;
            html += `
              <div class="constraint-item" id="constraint-${fullIdx}">
                <div class="constraint-name">${c.description}</div>
                <div class="constraint-meta">
                  <span class="constraint-category">${c.category}</span>
                  <span class="constraint-default" id="default-${fullIdx}">${c.default}</span>
                  <input type="text" class="constraint-input" id="input-${fullIdx}" value="${c.default}" style="display:none;" data-name="${c.name}">
                  <button class="constraint-delete-btn" onclick="event.stopPropagation(); deleteConstraint(${idx}, 'hard', ${cIdx})" title="åˆ é™¤æ­¤çº¦æŸ">ğŸ—‘ï¸</button>
                </div>
              </div>
            `;
          });
          html += `</div></div>`;
        }
        
        if (softConstraints.length > 0) {
          html += `
            <div class="constraint-group">
              <div class="constraint-group-title">
                <span class="constraint-type-badge soft">è½¯çº¦æŸ</span>
                <span class="constraint-group-desc">å°½é‡æ»¡è¶³ï¼Œç”¨äºä¼˜åŒ–æ’ç­è´¨é‡</span>
              </div>
              <div class="constraint-list">
          `;
          softConstraints.forEach((c, cIdx) => {
            const fullIdx = `${idx}-soft-${cIdx}`;
            html += `
              <div class="constraint-item soft" id="constraint-${fullIdx}">
                <div class="constraint-name">${c.description}</div>
                <div class="constraint-meta">
                  <span class="constraint-category">${c.category}</span>
                  <span class="constraint-default" id="default-${fullIdx}">${c.default}</span>
                  <input type="text" class="constraint-input" id="input-${fullIdx}" value="${c.default}" style="display:none;" data-name="${c.name}">
                  <button class="constraint-delete-btn" onclick="event.stopPropagation(); deleteConstraint(${idx}, 'soft', ${cIdx})" title="åˆ é™¤æ­¤çº¦æŸ">ğŸ—‘ï¸</button>
                </div>
              </div>
            `;
          });
          html += `</div></div>`;
        }
        
        html += `</div></div>`;
      });
      
      html += '</div>';
      return html;
    }

    function toggleTemplate(idx) {
      const body = document.getElementById('body-' + idx);
      const arrow = document.getElementById('arrow-' + idx);
      if (body.style.display === 'none') {
        body.style.display = 'block';
        arrow.textContent = 'â–²';
      } else {
        body.style.display = 'none';
        arrow.textContent = 'â–¼';
      }
    }

    // ç¼–è¾‘æ¨¡å¼çŠ¶æ€
    const editModeState = {};

    // å­˜å‚¨åŸå§‹å€¼ç”¨äºå–æ¶ˆæ¢å¤
    const originalValues = {};

    function toggleEditMode(idx) {
      const isEditing = editModeState[idx];
      const card = document.getElementById('template-' + idx);
      const defaults = card.querySelectorAll('.constraint-default');
      const inputs = card.querySelectorAll('.constraint-input');
      const editIcon = document.getElementById('editIcon-' + idx);
      const editText = document.getElementById('editText-' + idx);
      const cancelBtn = document.getElementById('cancelBtn-' + idx);

      if (!isEditing) {
        // ä¿å­˜åŸå§‹å€¼ç”¨äºå–æ¶ˆæ¢å¤
        originalValues[idx] = [];
        defaults.forEach(el => originalValues[idx].push(el.textContent));
        
        // è¿›å…¥ç¼–è¾‘æ¨¡å¼
        defaults.forEach(el => el.style.display = 'none');
        inputs.forEach(el => el.style.display = 'inline-block');
        editIcon.textContent = 'ğŸ’¾';
        editText.textContent = 'ä¿å­˜';
        cancelBtn.style.display = 'inline-flex';
        editModeState[idx] = true;
      } else {
        // ä¿å­˜å¹¶é€€å‡ºç¼–è¾‘æ¨¡å¼
        inputs.forEach((input, i) => {
          defaults[i].textContent = input.value;
          defaults[i].style.display = 'inline';
          input.style.display = 'none';
        });
        editIcon.textContent = 'âœï¸';
        editText.textContent = 'ç¼–è¾‘';
        cancelBtn.style.display = 'none';
        editModeState[idx] = false;
        
        // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
        showToast('âœ… çº¦æŸé…ç½®å·²ä¿å­˜');
      }
    }

    function cancelEditMode(idx) {
      const card = document.getElementById('template-' + idx);
      const defaults = card.querySelectorAll('.constraint-default');
      const inputs = card.querySelectorAll('.constraint-input');
      const editIcon = document.getElementById('editIcon-' + idx);
      const editText = document.getElementById('editText-' + idx);
      const cancelBtn = document.getElementById('cancelBtn-' + idx);

      // æ¢å¤åŸå§‹å€¼
      if (originalValues[idx]) {
        defaults.forEach((el, i) => {
          el.textContent = originalValues[idx][i] || el.textContent;
          el.style.display = 'inline';
        });
        inputs.forEach((input, i) => {
          input.value = originalValues[idx][i] || input.value;
          input.style.display = 'none';
        });
      }

      editIcon.textContent = 'âœï¸';
      editText.textContent = 'ç¼–è¾‘';
      cancelBtn.style.display = 'none';
      editModeState[idx] = false;
      
      showToast('ğŸ”„ å·²å–æ¶ˆç¼–è¾‘');
    }

    function applyTemplate(scenario, idx) {
      // è·å–å½“å‰æ¨¡æ¿çš„çº¦æŸå€¼
      const card = document.getElementById('template-' + idx);
      const inputs = card.querySelectorAll('.constraint-input');
      
      // æ„å»ºçº¦æŸé…ç½®å¯¹è±¡
      const constraintConfig = {};
      inputs.forEach(input => {
        const name = input.dataset.name;
        const value = input.value;
        // è§£ææ•°å€¼
        const numMatch = value.match(/(\d+)/);
        if (numMatch) {
          constraintConfig[name] = parseInt(numMatch[1]);
        } else {
          constraintConfig[name] = value;
        }
      });

      // å°è¯•æ›´æ–°å½“å‰è¯·æ±‚ä½“çš„çº¦æŸé…ç½®
      try {
        const currentReq = JSON.parse(requestBody.value);
        if (!currentReq.constraints) currentReq.constraints = {};
        if (!currentReq.constraints.config) currentReq.constraints.config = {};
        
        // åº”ç”¨çº¦æŸé…ç½®
        Object.assign(currentReq.constraints.config, constraintConfig);
        currentReq.scenario = scenario;
        
        requestBody.value = JSON.stringify(currentReq, null, 2);
        loadScenario(scenario === 'nursing' ? 'nursing' : scenario); // åˆ·æ–°ä¸šåŠ¡è§†å›¾
        
        showToast(`å·²åº”ç”¨ ${constraintTemplatesData[idx].name} åˆ°å½“å‰é…ç½®`);
        
        // åˆ‡æ¢åˆ°è¯·æ±‚é…ç½®tab
        switchMainTab('request');
      } catch (e) {
        showToast('åº”ç”¨å¤±è´¥: ' + e.message, 'error');
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.innerHTML = `<span>${type === 'success' ? 'âœ…' : 'âŒ'}</span> ${message}`;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 2000);
    }

    function showAddConstraintForm(idx) {
      const form = document.getElementById('addForm-' + idx);
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function hideAddConstraintForm(idx) {
      const form = document.getElementById('addForm-' + idx);
      form.style.display = 'none';
      // æ¸…ç©ºè¡¨å•
      document.getElementById('newType-' + idx).value = 'hard';
      document.getElementById('newName-' + idx).value = '';
      document.getElementById('newDesc-' + idx).value = '';
      document.getElementById('newCategory-' + idx).value = '';
      document.getElementById('newDefault-' + idx).value = '';
    }

    // ä»çº¦æŸåº“æ·»åŠ çº¦æŸ
    async function showAddFromLibrary(templateIdx, scenario) {
      // å¦‚æœçº¦æŸåº“æ•°æ®ä¸ºç©ºï¼Œå…ˆè·å–
      if (constraintLibraryData.length === 0) {
        const url = serverUrlInput.value;
        try {
          const response = await fetch(`${url}/api/v1/constraints/library`);
          const data = await response.json();
          constraintLibraryData = data.library || [];
        } catch(e) {
          showToast('è·å–çº¦æŸåº“å¤±è´¥', 'error');
          return;
        }
      }

      // è·å–å½“å‰æ¨¡æ¿å·²æœ‰çš„çº¦æŸåç§°
      const template = constraintTemplatesData[templateIdx];
      const existingNames = (template.constraints || []).map(c => c.name);

      // ç­›é€‰é€‚ç”¨äºå½“å‰åœºæ™¯çš„çº¦æŸï¼Œæ’é™¤å·²å­˜åœ¨çš„
      const available = constraintLibraryData.filter(c => 
        c.scenarios.includes(scenario) && !existingNames.includes(c.name)
      );

      if (available.length === 0) {
        showToast('è¯¥åœºæ™¯æ²¡æœ‰æ›´å¤šå¯æ·»åŠ çš„çº¦æŸ');
        return;
      }

      // æ„å»ºé€‰æ‹©å¯¹è¯æ¡†
      const modal = document.createElement('div');
      modal.className = 'library-modal';
      modal.id = 'libraryModal';
      modal.innerHTML = `
        <div class="library-modal-content">
          <div class="library-modal-header">
            <span>ğŸ“š ä»çº¦æŸåº“æ·»åŠ  - ${scenario}</span>
            <button onclick="closeLibraryModal()" class="library-modal-close">âœ•</button>
          </div>
          <div class="library-modal-body">
            ${available.map((c, i) => `
              <div class="library-select-item" onclick="selectConstraintFromLibrary(${templateIdx}, '${c.name}')">
                <div class="library-select-header">
                  <span class="constraint-type-badge ${c.type}">${c.type === 'hard' ? 'ç¡¬' : 'è½¯'}</span>
                  <span class="library-select-name">${c.display_name}</span>
                </div>
                <div class="library-select-desc">${c.description}</div>
                <div class="library-select-params">
                  ${c.params && c.params.length > 0 
                    ? c.params.map(p => `<span class="param-badge">${p.name}: ${p.default}</span>`).join('') 
                    : '<span class="param-badge">æ— å‚æ•°</span>'}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function closeLibraryModal() {
      const modal = document.getElementById('libraryModal');
      if (modal) modal.remove();
    }

    function selectConstraintFromLibrary(templateIdx, constraintName) {
      const libConstraint = constraintLibraryData.find(c => c.name === constraintName);
      if (!libConstraint) return;

      // æ„å»ºé»˜è®¤å€¼å­—ç¬¦ä¸²
      const defaultValue = libConstraint.params && libConstraint.params.length > 0
        ? libConstraint.params.map(p => p.default).join(', ')
        : 'å¯ç”¨';

      // åˆ›å»ºæ–°çº¦æŸ
      const newConstraint = {
        name: libConstraint.name,
        type: libConstraint.type,
        category: libConstraint.category,
        description: libConstraint.display_name,
        default: defaultValue
      };

      // æ·»åŠ åˆ°æ¨¡æ¿
      if (!constraintTemplatesData[templateIdx].constraints) {
        constraintTemplatesData[templateIdx].constraints = [];
      }
      constraintTemplatesData[templateIdx].constraints.push(newConstraint);

      // å…³é—­æ¨¡æ€æ¡†å¹¶åˆ·æ–°
      closeLibraryModal();
      refreshTemplateDisplay(templateIdx);
      showToast(`å·²æ·»åŠ çº¦æŸ: ${libConstraint.display_name}`);
    }

    function addNewConstraint(idx) {
      const type = document.getElementById('newType-' + idx).value;
      const name = document.getElementById('newName-' + idx).value.trim();
      const desc = document.getElementById('newDesc-' + idx).value.trim();
      const category = document.getElementById('newCategory-' + idx).value.trim();
      const defaultVal = document.getElementById('newDefault-' + idx).value.trim();

      if (!name || !desc || !category || !defaultVal) {
        showToast('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'error');
        return;
      }

      // åˆ›å»ºæ–°çº¦æŸå¯¹è±¡
      const newConstraint = {
        name: name,
        type: type,
        category: category,
        description: desc,
        default: defaultVal
      };

      // æ·»åŠ åˆ°æ¨¡æ¿æ•°æ®
      if (!constraintTemplatesData[idx].constraints) {
        constraintTemplatesData[idx].constraints = [];
      }
      constraintTemplatesData[idx].constraints.push(newConstraint);

      // é‡æ–°æ¸²æŸ“æ¨¡æ¿åˆ—è¡¨å¹¶ä¿æŒå±•å¼€çŠ¶æ€
      const templatesContainer = document.querySelector('.biz-section');
      templatesContainer.innerHTML = renderConstraintTemplates(constraintTemplatesData).replace('<div class="biz-section">', '').replace(/<\/div>$/, '');
      
      // é‡æ–°å±•å¼€å½“å‰æ¨¡æ¿
      const body = document.getElementById('body-' + idx);
      const arrow = document.getElementById('arrow-' + idx);
      if (body) {
        body.style.display = 'block';
        arrow.textContent = 'â–²';
      }

      showToast(`å·²æ·»åŠ æ–°${type === 'hard' ? 'ç¡¬' : 'è½¯'}çº¦æŸ: ${desc}`);
    }

    // åˆ é™¤çº¦æŸ
    function deleteConstraint(templateIdx, type, constraintIdx) {
      const template = constraintTemplatesData[templateIdx];
      if (!template || !template.constraints) return;

      // æ‰¾åˆ°å¹¶åˆ é™¤å¯¹åº”ç±»å‹çš„çº¦æŸ
      const constraints = template.constraints.filter(c => c.type === type);
      if (constraintIdx >= 0 && constraintIdx < constraints.length) {
        const targetConstraint = constraints[constraintIdx];
        const originalIdx = template.constraints.indexOf(targetConstraint);
        if (originalIdx > -1) {
          const deletedName = template.constraints[originalIdx].description;
          template.constraints.splice(originalIdx, 1);
          
          // é‡æ–°æ¸²æŸ“æ¨¡æ¿
          refreshTemplateDisplay(templateIdx);
          showToast(`å·²åˆ é™¤çº¦æŸ: ${deletedName}`);
        }
      }
    }

    // åˆ·æ–°æ¨¡æ¿æ˜¾ç¤º
    function refreshTemplateDisplay(templateIdx) {
      const container = document.querySelector('.biz-section');
      if (container) {
        const newHtml = renderConstraintTemplates(constraintTemplatesData);
        container.outerHTML = newHtml;
        // é‡æ–°å±•å¼€æ¨¡æ¿
        setTimeout(() => {
          const body = document.getElementById('body-' + templateIdx);
          const arrow = document.getElementById('arrow-' + templateIdx);
          if (body) {
            body.style.display = 'block';
            arrow.textContent = 'â–²';
          }
        }, 50);
      }
    }

    function showError(message) {
      // Auto switch to response tab
      switchMainTab('response');
      
      // Update status badge on main tab
      const statusBadge = document.getElementById('responseStatusBadge');
      const indicator = document.getElementById('responseIndicator');
      statusBadge.className = 'status-badge error';
      statusBadge.textContent = 'âœ—';
      indicator.style.display = 'none';

      responseMeta.style.display = 'flex';
      document.getElementById('responseStatus').textContent = 'ERROR';
      document.getElementById('responseStatus').className = 'response-meta-value error';
      resultsSummary.style.display = 'none';
      responseTabs.style.display = 'none';
      businessView.innerHTML = `<div class="biz-section"><div class="biz-message error"><span style="font-size:1.5rem">âŒ</span><span>${message}</span></div></div>`;
    }

    function syntaxHighlight(json) {
      return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
        m => `<span class="${/^"/.test(m) ? (/:$/.test(m) ? 'json-key' : 'json-string') : /true|false/.test(m) ? 'json-boolean' : /null/.test(m) ? 'json-null' : 'json-number'}">${m}</span>`);
    }

    function formatBytes(bytes) { return bytes < 1024 ? bytes + ' B' : bytes < 1048576 ? (bytes/1024).toFixed(1) + ' KB' : (bytes/1048576).toFixed(1) + ' MB'; }
    function formatRequest() { try { requestBody.value = JSON.stringify(JSON.parse(requestBody.value), null, 2); } catch(e) { alert('JSONé”™è¯¯: ' + e.message); } }
    function resetRequest() { loadScenario(currentScenario); }
    function clearResponse() {
      // Reset status badge on main tab
      const statusBadge = document.getElementById('responseStatusBadge');
      const indicator = document.getElementById('responseIndicator');
      statusBadge.className = 'status-badge waiting';
      statusBadge.textContent = 'â³';
      indicator.style.display = 'none';

      responseMeta.style.display = 'none';
      resultsSummary.style.display = 'none';
      responseTabs.style.display = 'none';
      businessView.innerHTML = `<div class="response-placeholder"><div class="response-placeholder-icon">ğŸ“¡</div><span>é€‰æ‹©åœºæ™¯å¹¶å‘é€è¯·æ±‚</span></div>`;
      responseOutput.innerHTML = '';
      lastResponse = null;
    }
    function copyResponse() { if (lastResponse) { navigator.clipboard.writeText(JSON.stringify(lastResponse, null, 2)); alert('å·²å¤åˆ¶'); } }

    async function checkHealth() {
      const url = serverUrlInput.value;
      const startTime = performance.now();
      try {
        const response = await fetch(`${url}/health`);
        const data = await response.json();
        lastResponse = data;
        showResponse(response.status, performance.now() - startTime, data);
      } catch(e) { showError('å¥åº·æ£€æŸ¥å¤±è´¥: ' + e.message); }
    }

    async function getVersion() {
      const url = serverUrlInput.value;
      const startTime = performance.now();
      try {
        const response = await fetch(`${url}/version`);
        const data = await response.json();
        lastResponse = data;
        showResponse(response.status, performance.now() - startTime, data);
      } catch(e) { showError('è·å–ç‰ˆæœ¬å¤±è´¥: ' + e.message); }
    }

    async function getConstraintTemplates() {
      const url = serverUrlInput.value;
      const startTime = performance.now();
      try {
        const response = await fetch(`${url}/api/v1/constraints/templates`);
        const data = await response.json();
        lastResponse = data;
        showResponse(response.status, performance.now() - startTime, data);
      } catch(e) { showError('è·å–æ¨¡æ¿å¤±è´¥: ' + e.message); }
    }

    // çº¦æŸåº“æ•°æ®ï¼ˆç”¨äºä»åº“ä¸­æ·»åŠ çº¦æŸï¼‰
    let constraintLibraryData = [];

    async function getConstraintLibrary() {
      const url = serverUrlInput.value;
      const startTime = performance.now();
      try {
        const response = await fetch(`${url}/api/v1/constraints/library`);
        const data = await response.json();
        constraintLibraryData = data.library || [];
        lastResponse = data;
        showResponse(response.status, performance.now() - startTime, data);
        switchMainTab('response');
      } catch(e) { showError('è·å–çº¦æŸåº“å¤±è´¥: ' + e.message); }
    }

    // æ¸²æŸ“çº¦æŸåº“
    function renderConstraintLibrary(library) {
      const scenarioNames = {
        restaurant: 'ğŸœ é¤é¥®',
        factory: 'ğŸ­ å·¥å‚',
        housekeeping: 'ğŸ  å®¶æ”¿',
        nursing: 'ğŸ’Š é•¿æŠ¤é™©'
      };

      // æŒ‰ç±»åˆ«åˆ†ç»„
      const grouped = {};
      library.forEach(c => {
        if (!grouped[c.category]) grouped[c.category] = [];
        grouped[c.category].push(c);
      });

      let html = `<div class="biz-section"><div class="biz-section-title">ğŸ“š çº¦æŸåº“ - åç«¯æ”¯æŒçš„æ‰€æœ‰çº¦æŸ (${library.length}é¡¹)</div>`;
      html += `<p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">ğŸ’¡ è¿™äº›æ˜¯åç«¯å®é™…æ”¯æŒçš„çº¦æŸè§„åˆ™ï¼Œå¯ç”¨äºé…ç½®æ’ç­è¯·æ±‚ã€‚</p>`;

      Object.entries(grouped).forEach(([category, constraints]) => {
        html += `
          <div class="library-category">
            <div class="library-category-header">${category} (${constraints.length})</div>
            <div class="library-constraints">
        `;
        constraints.forEach(c => {
          const scenarioTags = c.scenarios.map(s => `<span class="scenario-tag">${scenarioNames[s] || s}</span>`).join('');
          const paramList = c.params && c.params.length > 0 
            ? c.params.map(p => `<span class="param-badge" title="${p.description}">${p.name}: ${p.default}</span>`).join('')
            : '<span class="param-badge">æ— å‚æ•°</span>';
          
          html += `
            <div class="library-item ${c.type}">
              <div class="library-item-header">
                <span class="constraint-type-badge ${c.type}">${c.type === 'hard' ? 'ç¡¬' : 'è½¯'}</span>
                <span class="library-item-name">${c.display_name}</span>
                <code class="library-item-code">${c.name}</code>
              </div>
              <div class="library-item-desc">${c.description}</div>
              <div class="library-item-meta">
                <div class="scenario-tags">${scenarioTags}</div>
                <div class="param-list">${paramList}</div>
              </div>
            </div>
          `;
        });
        html += `</div></div>`;
      });

      html += '</div>';
      return html;
    }

    serverUrlInput.addEventListener('change', checkServerStatus);
  </script>
</body>
</html>
