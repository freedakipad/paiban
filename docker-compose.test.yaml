# PaiBan 排班引擎 - 测试环境 Docker Compose
# 使用方法: docker compose -f docker-compose.test.yaml up -d

services:
  # ================================
  # PostgreSQL 测试数据库
  # ================================
  postgres-test:
    image: postgres:15-alpine
    container_name: paiban-postgres-test
    environment:
      POSTGRES_DB: paiban_test
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test123
    ports:
      - "5433:5432"
    tmpfs:
      - /var/lib/postgresql/data  # 使用内存存储加速测试
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test -d paiban_test"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - paiban-test-network

  # ================================
  # Redis 测试实例
  # ================================
  redis-test:
    image: redis:7-alpine
    container_name: paiban-redis-test
    command: redis-server --appendonly no --save ""  # 禁用持久化加速测试
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - paiban-test-network

  # ================================
  # PaiBan 测试服务
  # ================================
  paiban-test:
    build:
      context: .
      dockerfile: deployments/Dockerfile.test
    container_name: paiban-test
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    environment:
      APP_ENV: test
      APP_PORT: 7012
      APP_LOG_LEVEL: warn
      
      DB_HOST: postgres-test
      DB_PORT: 5432
      DB_NAME: paiban_test
      DB_USER: test
      DB_PASSWORD: test123
      DB_SSL_MODE: disable
      
      REDIS_HOST: redis-test
      REDIS_PORT: 6379
      REDIS_DB: 0
    ports:
      - "7013:7012"
    networks:
      - paiban-test-network

  # ================================
  # 集成测试运行器
  # ================================
  integration-test:
    build:
      context: .
      dockerfile: deployments/Dockerfile.test
    container_name: paiban-integration-test
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    environment:
      APP_ENV: test
      DB_HOST: postgres-test
      DB_PORT: 5432
      DB_NAME: paiban_test
      DB_USER: test
      DB_PASSWORD: test123
      REDIS_HOST: redis-test
      REDIS_PORT: 6379
    command: ["go", "test", "-v", "-tags=integration", "./tests/integration/..."]
    volumes:
      - ./:/app
      - go-cache:/go/pkg/mod
    networks:
      - paiban-test-network

  # ================================
  # E2E 测试运行器
  # ================================
  e2e-test:
    build:
      context: .
      dockerfile: deployments/Dockerfile.test
    container_name: paiban-e2e-test
    depends_on:
      paiban-test:
        condition: service_started
    environment:
      PAIBAN_URL: http://paiban-test:7012
      TEST_API_KEY: test-api-key
    command: ["go", "test", "-v", "-tags=e2e", "./tests/e2e/..."]
    volumes:
      - ./:/app
      - go-cache:/go/pkg/mod
    networks:
      - paiban-test-network

# ================================
# 网络配置
# ================================
networks:
  paiban-test-network:
    driver: bridge

# ================================
# 数据卷
# ================================
volumes:
  go-cache:
    driver: local

