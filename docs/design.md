# 通用排班引擎服务 - 需求分析与设计方案

> 版本：v1.2  
> 日期：2026-01-11  
> 项目代号：PaiBan（排班引擎）

---

## 🎯 系统定位

**PaiBan 是一个独立的排班引擎服务**，专注于提供智能排班计算能力，通过标准化 API 接口对外输出排班结果。

```
┌─────────────────────────────────────────────────────────────────────┐
│                         系统定位                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   PaiBan 是什么：                                                    │
│   ✅ 独立的排班计算引擎                                              │
│   ✅ 标准化的 REST API 服务                                          │
│   ✅ 可被任何业务系统集成调用                                         │
│   ✅ 支持多场景的约束求解器                                          │
│                                                                     │
│   PaiBan 不是什么：                                                  │
│   ❌ 不是完整的业务管理系统                                          │
│   ❌ 不提供前端界面（由调用方自行实现）                               │
│   ❌ 不直接管理员工考勤、工资等业务                                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                       典型集成模式                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌──────────────┐      API 调用       ┌──────────────┐            │
│   │   餐饮 ERP   │  ────────────────▶  │              │            │
│   └──────────────┘                     │              │            │
│                                        │   PaiBan     │            │
│   ┌──────────────┐      API 调用       │   排班引擎   │            │
│   │   工厂 MES   │  ────────────────▶  │              │            │
│   └──────────────┘                     │              │            │
│                                        │  ┌────────┐  │            │
│   ┌──────────────┐      API 调用       │  │ 排班   │  │            │
│   │  家政平台    │  ────────────────▶  │  │ 结果   │  │            │
│   └──────────────┘                     │  └────────┘  │            │
│                                        │              │            │
│   ┌──────────────┐      API 调用       │              │            │
│   │  长护险系统  │  ────────────────▶  │              │            │
│   └──────────────┘                     └──────────────┘            │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 目录

1. [项目背景与目标](#1-项目背景与目标)
2. [业务场景分析](#2-业务场景分析)
3. [功能需求](#3-功能需求)
4. [非功能需求](#4-非功能需求)
5. [系统架构设计](#5-系统架构设计)
6. [数据模型设计](#6-数据模型设计)
7. [约束系统设计](#7-约束系统设计)
8. [排班算法设计](#8-排班算法设计)
9. [API 设计](#9-api-设计)
10. [集成指南](#10-集成指南)
11. [实现路线图](#11-实现路线图)
12. [附录](#附录)

---

## 1. 项目背景与目标

### 1.1 背景

现代服务业和制造业面临复杂的人员排班挑战：

- **餐饮业**：波峰波谷明显，临时调班频繁
- **工厂流水线**：24小时连续生产，倒班制度复杂
- **医疗行业**：资质要求严格，值班制度特殊
- **零售业**：节假日波动大，多门店协调
- **家政服务**：订单驱动，路线优化，客户匹配复杂
- **长护险**：政策合规要求高，护理计划严格执行

传统排班方式（Excel/手工）存在以下问题：

| 问题 | 影响 |
|------|------|
| 效率低下 | 排班耗时数小时，难以快速响应变化 |
| 容易出错 | 人工核对约束条件，遗漏和冲突频发 |
| 公平性差 | 主观因素影响，员工抱怨不均 |
| 难以优化 | 无法综合考虑成本、效率、满意度 |

### 1.2 目标

构建一个**独立部署、通用化、可配置**的排班引擎服务：

```
┌─────────────────────────────────────────────────────────────┐
│                       核心目标                              │
├─────────────────────────────────────────────────────────────┤
│  ✅ 独立服务：作为独立微服务部署，提供标准化 API            │
│  ✅ 通用性：一套引擎支持餐饮/工厂/家政/长护险多种场景       │
│  ✅ 智能化：自动生成满足约束的最优排班方案                  │
│  ✅ 灵活性：约束规则可配置，适应不同业务场景                │
│  ✅ 易集成：简洁的 REST API，方便第三方系统对接             │
│  ✅ 高性能：快速求解大规模排班问题（500+资源）              │
└─────────────────────────────────────────────────────────────┘
```

### 1.3 核心输入输出

```
┌─────────────────────────────────────────────────────────────────────┐
│                     排班引擎 输入/输出                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   【输入】                          【输出】                        │
│   ━━━━━━                            ━━━━━━                          │
│                                                                     │
│   ┌─────────────────┐               ┌─────────────────┐            │
│   │ 资源列表        │               │ 排班结果        │            │
│   │ (员工/护理员)   │               │ (谁-何时-做什么) │            │
│   └─────────────────┘               └─────────────────┘            │
│                                                                     │
│   ┌─────────────────┐               ┌─────────────────┐            │
│   │ 需求/订单       │    ──────▶    │ 评分报告        │            │
│   │ (班次/服务请求) │               │ (约束满足度)    │            │
│   └─────────────────┘               └─────────────────┘            │
│                                                                     │
│   ┌─────────────────┐               ┌─────────────────┐            │
│   │ 约束规则        │               │ 冲突/警告       │            │
│   │ (硬约束/软约束) │               │ (违规明细)      │            │
│   └─────────────────┘               └─────────────────┘            │
│                                                                     │
│   ┌─────────────────┐                                              │
│   │ 场景配置        │                                              │
│   │ (餐饮/工厂/...) │                                              │
│   └─────────────────┘                                              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.4 成功指标

| 指标 | 目标值 |
|------|--------|
| **排班 API 响应时间** | < 30秒（100资源规模） |
| **约束满足率** | 硬约束 100%，软约束 > 90% |
| **派单 API 响应时间** | < 3秒（单日100订单） |
| **API 吞吐量** | > 100 QPS |
| **系统可用性** | 99.9% |

---

## 2. 业务场景分析

### 2.1 餐饮业场景

#### 2.1.1 业务特点

```
              客流量曲线（典型工作日）
    ▲
    │
100%│          ████                    ████
    │         ██████                  ██████
 50%│    ████████████    ████    ████████████
    │  ████████████████████████████████████████
    └──────────────────────────────────────────▶
       6   8  10  12  14  16  18  20  22  24  时间
           早餐    午餐  下午茶  晚餐    宵夜
```

#### 2.1.2 核心需求

| 需求类型 | 具体需求 |
|----------|----------|
| **班次管理** | 早班(6:00-14:00)、午班(11:00-19:00)、晚班(14:00-22:00)、通班(10:00-14:00,17:00-21:00) |
| **岗位配置** | 前厅服务员、后厨厨师、收银员、领班、清洁工 |
| **高峰保障** | 午高峰(11:00-13:00)服务员≥6人，晚高峰(18:00-20:00)≥8人 |
| **技能要求** | 咖啡师需咖啡证书，调酒师需调酒证书 |
| **排班周期** | 按周排班，提前一周发布 |

#### 2.1.3 约束示例

```yaml
# 餐饮场景约束配置
scenario: "restaurant"
constraints:
  hard:  # 硬约束（必须满足）
    - type: "max_hours_per_day"
      value: 10
    - type: "min_rest_between_shifts"
      value: "10h"
    - type: "skill_required"
      rules:
        - position: "咖啡师"
          skill: "咖啡师证书"
          
  soft:  # 软约束（尽量满足）
    - type: "employee_preference"
      weight: 50
    - type: "workload_balance"
      weight: 80
    - type: "minimize_overtime"
      weight: 70
```

---

### 2.2 工厂流水线场景

#### 2.2.1 业务特点

```
        三班倒轮换模式
    
    周一  周二  周三  周四  周五  周六  周日
    ─────────────────────────────────────────
A组  白    白    白    白    休    休    夜
B组  中    中    中    中    白    白    白  
C组  夜    夜    休    休    中    中    中
    
    白班: 08:00 - 16:00
    中班: 16:00 - 24:00
    夜班: 00:00 - 08:00
```

#### 2.2.2 核心需求

| 需求类型 | 具体需求 |
|----------|----------|
| **班组管理** | A/B/C三个班组，按固定模式轮换 |
| **产线覆盖** | 每条产线需配置：操作工×2、质检员×1、组长×1 |
| **资质要求** | 特种设备操作需持证上岗（叉车证、焊工证等） |
| **倒班规则** | 白→中→夜顺序轮换，连续夜班≤3天 |
| **交接班** | 班次间隔30分钟交接时间 |

#### 2.2.3 约束示例

```yaml
# 工厂场景约束配置
scenario: "factory"
constraints:
  hard:
    - type: "shift_rotation_pattern"
      pattern: "三班倒"
      sequence: ["白班", "中班", "夜班"]
    - type: "production_line_coverage"
      lines:
        - name: "A线"
          requirements:
            - role: "操作工"
              count: 2
            - role: "质检员"
              count: 1
    - type: "certification_required"
      rules:
        - position: "叉车工"
          cert: "叉车操作证"
          
  soft:
    - type: "max_consecutive_night_shifts"
      value: 3
      weight: 90
    - type: "team_together"  # 班组成员尽量在一起
      weight: 60
```

---

### 2.3 家政服务场景

#### 2.3.1 业务特点

家政服务是典型的**外派服务模式**，员工需要前往客户家中提供服务。

```
                    家政服务派单模式
    
    ┌──────────┐        ┌──────────┐        ┌──────────┐
    │  服务订单 │   →    │  智能派单 │   →    │  服务执行 │
    │  (客户)  │        │  (排班)   │        │  (阿姨)  │
    └──────────┘        └──────────┘        └──────────┘
         │                   │                   │
         ▼                   ▼                   ▼
    ┌─────────┐         ┌─────────┐         ┌─────────┐
    │ 服务类型 │         │ 技能匹配 │         │ 上门服务 │
    │ 服务时长 │         │ 距离优化 │         │ 服务记录 │
    │ 服务地址 │         │ 偏好匹配 │         │ 客户评价 │
    └─────────┘         └─────────┘         └─────────┘
```

#### 2.3.2 服务类型

| 服务类型 | 服务模式 | 排班特点 |
|----------|----------|----------|
| **钟点工** | 按小时计费 | 碎片化时间、多客户穿插 |
| **日常保洁** | 固定周期 | 每周X次、固定时段 |
| **深度保洁** | 单次预约 | 4-8小时、需多人协作 |
| **住家保姆** | 全天候 | 24小时驻家、轮休制度 |
| **育儿嫂** | 全天候 | 专业技能、长期服务 |
| **月嫂** | 26天制 | 高技能、排期预约 |
| **老人陪护** | 灵活制 | 与长护险联动 |

#### 2.3.3 核心需求

| 需求类型 | 具体需求 |
|----------|----------|
| **订单驱动排班** | 根据客户订单动态分配服务人员 |
| **技能匹配** | 服务类型与服务员技能对应（育婴、烹饪、护理等） |
| **地理位置优化** | 考虑服务员住址与客户距离，减少通勤时间 |
| **客户偏好** | 老客户优先匹配熟悉的服务员 |
| **服务时长管理** | 不同服务项目的标准工时 |
| **路程时间** | 上门服务需预留路途时间 |
| **多客户串联** | 钟点工一天可服务多个客户，需合理安排顺序 |

#### 2.3.4 约束示例

```yaml
# 家政服务场景约束配置
scenario: "housekeeping"
constraints:
  hard:
    - type: "max_hours_per_day"
      value: 10
      
    - type: "skill_required"
      rules:
        - service_type: "月嫂"
          required_skills: ["月嫂证", "母婴护理证"]
        - service_type: "育儿嫂"
          required_skills: ["育婴师证"]
        - service_type: "老人陪护"
          required_skills: ["护理员证"]
          
    - type: "travel_time_buffer"
      config:
        min_buffer_minutes: 30  # 两个订单之间至少30分钟路程时间
        
    - type: "service_area_match"
      config:
        max_distance_km: 15  # 服务员住址与客户距离不超过15公里
        
  soft:
    - type: "customer_preference"
      weight: 90  # 优先分配客户熟悉的服务员
      config:
        prefer_familiar: true
        
    - type: "minimize_travel_distance"
      weight: 70
      config:
        optimize_route: true  # 多客户时优化路线顺序
        
    - type: "workload_balance"
      weight: 60
      
    - type: "rating_threshold"
      weight: 50
      config:
        min_rating: 4.0  # 优先分配评分4.0以上的服务员
```

---

### 2.4 长护险（长期护理保险）场景

#### 2.4.1 业务特点

长期护理保险是国家医保政策，为失能老人提供居家或机构护理服务。

```
                    长护险服务流程
    
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   评估定级          护理计划           服务派单          服务执行 │
│   ┌─────┐          ┌─────┐           ┌─────┐          ┌─────┐  │
│   │ 失能 │    →    │ 护理 │     →    │ 护理 │    →    │ 上门 │  │
│   │ 等级 │          │ 方案 │           │ 员派│          │ 服务 │  │
│   │ 评定 │          │ 制定 │           │ 单  │          │ 记录 │  │
│   └─────┘          └─────┘           └─────┘          └─────┘  │
│      │                │                 │                │     │
│   1-6级            服务项目          技能匹配         打卡核销   │
│                    服务频次          资质验证         政府监管   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 2.4.2 失能等级与服务标准

| 失能等级 | 服务频次 | 服务时长/次 | 护理员要求 |
|----------|----------|-------------|------------|
| 一级（轻度） | 3次/周 | 1小时 | 初级护理员 |
| 二级（轻度） | 4次/周 | 1小时 | 初级护理员 |
| 三级（中度） | 5次/周 | 1小时 | 中级护理员 |
| 四级（中度） | 6次/周 | 1-1.5小时 | 中级护理员 |
| 五级（重度） | 7次/周 | 1.5小时 | 高级护理员 |
| 六级（重度） | 7次/周 | 2小时 | 高级护理员 |

#### 2.4.3 核心需求

| 需求类型 | 具体需求 |
|----------|----------|
| **护理计划执行** | 按评估等级确定的服务频次和时长执行 |
| **资质严格匹配** | 护理员资质必须满足失能等级要求 |
| **固定护理员** | 老人习惯性强，尽量固定护理员 |
| **服务时段偏好** | 老人有固定的生活习惯，服务时段需相对固定 |
| **定期服务** | 每周固定X次，需规律排班 |
| **政府监管合规** | 服务记录上传、打卡核销、数据备查 |
| **服务项目标准化** | 助浴、助洁、助餐、生命体征监测等标准项目 |
| **异常处理** | 护理员请假时需安排替补且及时通知老人家属 |

#### 2.4.4 约束示例

```yaml
# 长护险场景约束配置
scenario: "long_term_care"
constraints:
  hard:
    - type: "certification_level_required"
      rules:
        - care_level: [1, 2]
          required_cert: "初级护理员证"
        - care_level: [3, 4]
          required_cert: "中级护理员证"
        - care_level: [5, 6]
          required_cert: "高级护理员证"
          
    - type: "care_plan_compliance"
      config:
        enforce_frequency: true   # 强制按护理计划频次
        enforce_duration: true    # 强制按护理计划时长
        
    - type: "service_area_match"
      config:
        max_distance_km: 10
        
    - type: "max_patients_per_day"
      value: 6  # 每个护理员每天最多服务6位老人
      
  soft:
    - type: "caregiver_continuity"
      weight: 95  # 最高优先级：保持护理员稳定
      config:
        prefer_same_caregiver: true
        max_caregiver_changes_per_month: 2
        
    - type: "service_time_regularity"
      weight: 85  # 尽量固定服务时间
      config:
        preferred_time_tolerance_minutes: 30
        
    - type: "workload_balance"
      weight: 60
      
    - type: "minimize_travel_distance"
      weight: 50
```

#### 2.4.5 特殊功能需求

| 功能 | 描述 |
|------|------|
| **护理计划管理** | 根据评估等级自动生成服务计划 |
| **服务包管理** | 标准服务项目组合（助浴包、康复包等） |
| **打卡核销** | 支持GPS打卡、人脸识别核销 |
| **家属通知** | 服务前后通知家属，异常情况预警 |
| **政府对接** | 数据上报医保系统 |
| **服务评价** | 老人/家属评价，服务质量追踪 |

---

### 2.5 派出服务通用特征

家政服务和长护险属于**派出服务（Field Service）**模式，与驻场服务有本质区别：

```
┌─────────────────────────────────────────────────────────────────────┐
│                     驻场服务 vs 派出服务                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   驻场服务（餐饮/工厂）           派出服务（家政/长护险）            │
│   ━━━━━━━━━━━━━━━━━━━━           ━━━━━━━━━━━━━━━━━━━━━━━━━━━        │
│                                                                     │
│   • 固定工作地点                 • 员工外派到客户处                 │
│   • 需求驱动（岗位人数）         • 订单驱动（服务请求）             │
│   • 班次固定                     • 服务时长灵活                     │
│   • 无需考虑路程                 • 需优化路线和通勤                 │
│   • 员工无差别                   • 强调客户-员工匹配                │
│   • 实时在场监管                 • 远程打卡核销                     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### 派出服务额外概念

| 概念 | 定义 | 适用场景 |
|------|------|----------|
| **ServiceOrder** | 服务订单（客户、服务类型、时间、地址） | 家政、长护险 |
| **Customer** | 客户（地址、偏好、历史服务员） | 家政、长护险 |
| **CarePlan** | 护理计划（等级、频次、时长） | 长护险 |
| **ServiceRecord** | 服务记录（签到、签退、服务项目） | 家政、长护险 |
| **TravelTime** | 路程时间（两点间通勤时间估算） | 家政、长护险 |
| **ServiceArea** | 服务区域（员工可服务的地理范围） | 家政、长护险 |

---

### 2.6 通用模型抽象

通过分析不同场景，提取出以下通用概念：

```
┌─────────────────────────────────────────────────────────────────┐
│                      通用领域模型                                │
├────────────────┬────────────────────────────────────────────────┤
│   概念         │                   定义                         │
├────────────────┼────────────────────────────────────────────────┤
│ Organization   │ 组织（公司/门店/工厂/护理站）                  │
│ Department     │ 部门（前厅/后厨/车间/服务组）                  │
│ Position       │ 岗位（服务员/厨师/操作工/护理员）              │
│ Employee       │ 员工（具有技能、偏好、可用性、服务区域）       │
│ Skill          │ 技能/资质（证书、等级、有效期）                │
│ Shift          │ 班次模板（开始时间、结束时间、类型）           │
│ ShiftGroup     │ 班组（用于倒班制）                             │
│ TimeSlot       │ 时间槽（日期+班次的具体实例）                  │
│ Demand         │ 需求（某时段某岗位需要多少人）                 │
│ Assignment     │ 排班分配（员工→时间槽的映射）                  │
│ Constraint     │ 约束（硬约束/软约束）                          │
│ Schedule       │ 排班表（一段时间内所有分配的集合）             │
├────────────────┼────────────────────────────────────────────────┤
│ 【派出服务扩展】│                                                │
├────────────────┼────────────────────────────────────────────────┤
│ Customer       │ 客户（地址、联系方式、偏好、服务历史）         │
│ ServiceOrder   │ 服务订单（客户、服务类型、预约时间）           │
│ ServiceRecord  │ 服务记录（签到签退、服务项目、评价）           │
│ CarePlan       │ 护理计划（仅长护险：等级、频次、服务包）       │
│ TravelMatrix   │ 路程矩阵（员工-客户间的通勤时间/距离）         │
│ ServiceArea    │ 服务区域（员工可服务的地理区域）               │
└────────────────┴────────────────────────────────────────────────┘
```

#### 场景概念映射表

| 通用概念 | 餐饮场景 | 工厂场景 | 家政场景 | 长护险场景 |
|----------|----------|----------|----------|------------|
| **Resource** | 员工 | 工人 | 阿姨/保姆 | 护理员 |
| **Position** | 服务员/厨师 | 操作工/质检 | 保洁/月嫂 | 初/中/高级护理员 |
| **Skill** | 咖啡/调酒 | 叉车证/焊工证 | 育婴/烹饪 | 护理员等级证 |
| **Location** | 门店/区域 | 车间/产线 | 服务区域 | 服务区域 |
| **TimeSlot** | 早/午/晚班 | 白/中/夜班 | 服务时段 | 服务时段 |
| **Demand** | 高峰人数 | 产能要求 | 订单需求 | 护理计划 |
| **Target** | 岗位 | 产线 | 客户 | 老人 |

---

## 3. 功能需求

### 3.1 功能模块总览

```
┌─────────────────────────────────────────────────────────────────┐
│                     PaiBan 排班引擎服务                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  【核心引擎】                                                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  驻场排班    │  │  派出服务    │  │  冲突检测    │          │
│  │  引擎        │  │  派单引擎    │  │  引擎        │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                 │
│  【约束系统】                                                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  约束管理    │  │  场景适配    │  │  公平性      │          │
│  │  Framework   │  │  Adapter     │  │  评估        │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                 │
│  【API 服务】                                                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  排班 API    │  │  派单 API    │  │  统计 API    │          │
│  │  /schedule   │  │  /dispatch   │  │  /stats      │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 核心 API 功能

#### 3.2.1 驻场排班 API

| API | 描述 | 优先级 |
|-----|------|--------|
| **POST /schedule/generate** | 自动生成排班方案 | P0 |
| **POST /schedule/validate** | 校验排班方案，返回冲突列表 | P0 |
| **POST /schedule/optimize** | 优化已有排班（局部调整） | P1 |
| **POST /schedule/check-conflict** | 检测单个分配是否冲突 | P0 |
| **POST /schedule/recommend** | 推荐某时段可用员工 | P1 |

#### 3.2.2 派出服务 API

| API | 描述 | 优先级 |
|-----|------|--------|
| **POST /dispatch/assign** | 智能派单（订单→员工匹配） | P0 |
| **POST /dispatch/route** | 路线优化（多订单排序） | P1 |
| **POST /dispatch/recommend** | 推荐可用服务员 | P1 |
| **POST /dispatch/reassign** | 重新分配订单 | P1 |

#### 3.2.3 调班评估 API

| API | 描述 | 优先级 |
|-----|------|--------|
| **POST /swap/evaluate** | 评估调班可行性 | P0 |
| **POST /swap/recommend** | 推荐可换班员工 | P1 |
| **POST /swap/batch-evaluate** | 批量评估调班 | P2 |

#### 3.2.4 约束配置 API

| API | 描述 | 优先级 |
|-----|------|--------|
| **GET /constraints/templates** | 获取场景约束模板 | P0 |
| **POST /constraints/validate** | 验证约束配置格式 | P1 |
| **GET /constraints/types** | 获取支持的约束类型列表 | P1 |

#### 3.2.5 统计查询 API

| API | 描述 | 优先级 |
|-----|------|--------|
| **POST /stats/workload** | 工作量统计分析 | P1 |
| **POST /stats/fairness** | 公平性评估报告 | P2 |
| **POST /stats/coverage** | 需求覆盖率统计 | P1 |

---

### 3.3 API 认证与授权

```
┌─────────────────────────────────────────────────────────────┐
│                      API 认证机制                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   认证方式：Bearer Token（API Key）                          │
│   ─────────────────────────────────────────────────────     │
│   Authorization: Bearer YOUR_API_KEY                        │
│                                                             │
│   数据隔离：                                                 │
│   ─────────────────────────────────────────────────────     │
│   • 每个 API Key 对应独立的数据空间                          │
│   • 约束模板可按 API Key 自定义                              │
│   • 调用日志按 API Key 隔离                                  │
│                                                             │
│   限流规则：                                                 │
│   ─────────────────────────────────────────────────────     │
│   • 默认：100 QPS                                           │
│   • 可申请提升配额                                           │
│   • 超限返回 429 Too Many Requests                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. 非功能需求

### 4.1 性能需求

| 指标 | 要求 |
|------|------|
| 自动排班响应时间 | 100人/周排班 < 30秒 |
| 页面加载时间 | < 2秒 |
| 并发用户数 | 支持 1000 并发 |
| 数据保留期 | 排班数据保留 3 年 |

### 4.2 可用性需求

| 指标 | 要求 |
|------|------|
| 系统可用性 | 99.9%（全年宕机 < 8.76 小时） |
| 计划内维护窗口 | 每月 1 次，凌晨 2-4 点 |
| 故障恢复时间 | RTO < 1 小时 |
| 数据恢复点 | RPO < 15 分钟 |

### 4.3 安全需求

| 类型 | 要求 |
|------|------|
| 身份认证 | 支持用户名密码、SSO、OAuth2.0 |
| 数据加密 | 传输 TLS 1.2+，存储 AES-256 |
| 审计日志 | 记录所有敏感操作 |
| 数据隔离 | 多租户数据严格隔离 |

### 4.4 可扩展性需求

| 类型 | 要求 |
|------|------|
| 水平扩展 | 支持添加服务器节点扩容 |
| 插件机制 | 支持自定义约束插件 |
| API 开放 | 提供完整的 REST API |
| 多语言 | 支持中文、英文 |

---

## 5. 系统架构设计

### 5.1 整体架构

PaiBan 作为独立的排班引擎服务，被各业务系统通过 API 调用：

```
┌─────────────────────────────────────────────────────────────────────┐
│                         调用方（业务系统）                           │
│                                                                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐           │
│  │ 餐饮 ERP │  │ 工厂 MES │  │ 家政平台 │  │ 长护险   │           │
│  │  系统    │  │  系统    │  │  APP     │  │  系统    │           │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘           │
│       │             │             │             │                  │
└───────┼─────────────┼─────────────┼─────────────┼──────────────────┘
        │             │             │             │
        └─────────────┴──────┬──────┴─────────────┘
                             │ REST API
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     PaiBan 排班引擎服务                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                       API 接口层                             │   │
│  │  ┌─────────────────────────────────────────────────────┐    │   │
│  │  │  认证鉴权 │ 限流熔断 │ 请求路由 │ 日志追踪         │    │   │
│  │  └─────────────────────────────────────────────────────┘    │   │
│  │                                                             │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐   │   │
│  │  │ 驻场排班  │ │ 派出服务  │ │ 冲突检测  │ │ 统计查询  │   │   │
│  │  │ /schedule │ │ /dispatch │ │ /validate │ │ /stats    │   │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      核心引擎层                              │   │
│  │                                                             │   │
│  │  ┌────────────────────────────────────────────────────┐    │   │
│  │  │              排班求解器 (Scheduler Solver)          │    │   │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐            │    │   │
│  │  │  │ 贪心算法 │ │ 局部搜索 │ │ 遗传算法 │            │    │   │
│  │  │  └──────────┘ └──────────┘ └──────────┘            │    │   │
│  │  └────────────────────────────────────────────────────┘    │   │
│  │                                                             │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │   │
│  │  │ 约束管理 │ │ 场景适配 │ │ 公平评估 │ │ 路线优化 │       │   │
│  │  │ Manager  │ │ Adapter  │ │ Fairness │ │ Router   │       │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      场景适配层                              │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐   │   │
│  │  │ 餐饮适配器│ │ 工厂适配器│ │ 家政适配器│ │ 长护适配器│   │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      数据存储层                              │   │
│  │  ┌──────────────┐  ┌──────────────┐                         │   │
│  │  │  PostgreSQL  │  │    Redis     │                         │   │
│  │  │ (约束/配置)  │  │  (缓存/锁)   │                         │   │
│  │  └──────────────┘  └──────────────┘                         │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.2 技术选型

| 层级 | 技术选型 | 说明 |
|------|----------|------|
| **后端语言** | Go 1.21+ | 高性能、并发友好、单二进制部署 |
| **Web 框架** | Gin | 轻量高效的 HTTP 框架 |
| **数据库** | PostgreSQL 15+ | 支持复杂查询、JSONB 存储约束配置 |
| **缓存** | Redis 7+ | 计算结果缓存、分布式锁 |
| **API 文档** | OpenAPI 3.0 / Swagger | 标准化 API 文档，便于集成 |
| **容器化** | Docker | 容器化部署，支持 K8s |
| **监控** | Prometheus + Grafana | 性能监控和告警 |

### 5.3 模块划分

```
paiban/
├── cmd/                          # 应用入口
│   └── server/
│       └── main.go               # 服务启动入口
│
├── internal/                     # 内部模块（不对外暴露）
│   ├── config/                   # 配置管理
│   ├── handler/                  # HTTP 处理器
│   │   ├── schedule_handler.go   # 驻场排班 API
│   │   ├── dispatch_handler.go   # 派出服务 API
│   │   └── validate_handler.go   # 冲突检测 API
│   ├── middleware/               # 中间件（认证、日志、限流）
│   └── repository/               # 数据访问层
│
├── pkg/                          # 🔥 核心引擎包（可独立使用）
│   ├── scheduler/                # 驻场排班引擎
│   │   ├── engine.go             # 排班引擎入口
│   │   ├── solver/               # 求解算法
│   │   │   ├── greedy.go         # 贪心算法
│   │   │   ├── local_search.go   # 局部搜索
│   │   │   └── genetic.go        # 遗传算法（可选）
│   │   └── optimizer/            # 优化器
│   │
│   ├── dispatcher/               # 派出服务派单引擎
│   │   ├── engine.go             # 派单引擎入口
│   │   ├── matcher/              # 技能/距离/偏好匹配
│   │   └── router/               # 路线优化（VRP）
│   │
│   ├── constraint/               # 通用约束系统
│   │   ├── constraint.go         # 约束接口
│   │   ├── builtin/              # 内置约束实现
│   │   └── validator.go          # 约束校验器
│   │
│   ├── adapter/                  # 场景适配器
│   │   ├── restaurant.go         # 餐饮场景
│   │   ├── factory.go            # 工厂场景
│   │   ├── housekeeping.go       # 家政场景
│   │   └── nursing.go            # 长护险场景
│   │
│   └── model/                    # 通用数据模型
│       ├── resource.go           # 资源（员工/护理员）
│       ├── demand.go             # 需求（班次/订单）
│       ├── assignment.go         # 分配结果
│       └── schedule.go           # 排班表
│
├── api/                          # API 定义
│   ├── openapi.yaml              # OpenAPI 3.0 规范
│   └── proto/                    # gRPC 定义（可选）
│
├── configs/                      # 配置文件
│   ├── constraints/              # 约束模板
│   │   ├── restaurant.yaml       # 餐饮约束模板
│   │   ├── factory.yaml          # 工厂约束模板
│   │   ├── housekeeping.yaml     # 家政约束模板
│   │   └── nursing.yaml          # 长护险约束模板
│   └── app.yaml                  # 应用配置
│
├── scripts/                      # 脚本
├── deployments/                  # 部署配置
│   ├── Dockerfile
│   └── docker-compose.yaml
│
└── docs/                         # 文档
    ├── design.md                 # 设计文档
    └── api-guide.md              # API 接入指南
```

---

## 6. 数据模型设计

### 6.1 ER 图

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│   Organization  │       │    Department   │       │    Position     │
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ id              │───┐   │ id              │───┐   │ id              │
│ name            │   │   │ org_id (FK)     │   │   │ dept_id (FK)    │
│ code            │   │   │ name            │   │   │ name            │
│ type (场景)     │   │   │ parent_id       │   │   │ level           │
│ settings (JSON) │   │   │ settings        │   │   │ required_skills │
│ created_at      │   │   │ created_at      │   │   │ created_at      │
└─────────────────┘   │   └─────────────────┘   │   └─────────────────┘
                      │           │             │           │
                      │           ▼             │           ▼
┌─────────────────┐   │   ┌─────────────────┐   │   ┌─────────────────┐
│     Employee    │◄──┴───│  EmployeeSkill  │   │   │      Skill      │
├─────────────────┤       ├─────────────────┤   │   ├─────────────────┤
│ id              │       │ employee_id(FK) │   │   │ id              │
│ org_id (FK)     │       │ skill_id (FK)   │   │   │ org_id (FK)     │
│ dept_id (FK)    │       │ level           │   │   │ name            │
│ position_id(FK) │◄──────│ cert_no         │   │   │ type            │
│ name            │       │ expire_at       │   │   │ description     │
│ employee_no     │       │ created_at      │   │   │ created_at      │
│ phone           │       └─────────────────┘   │   └─────────────────┘
│ email           │                             │
│ status          │                             │
│ preferences     │  ┌──────────────────────────┘
│ created_at      │  │
└─────────────────┘  │
        │            │
        │            ▼
        │    ┌─────────────────┐       ┌─────────────────┐
        │    │   ShiftTemplate │       │    ShiftGroup   │
        │    ├─────────────────┤       ├─────────────────┤
        │    │ id              │       │ id              │
        │    │ org_id (FK)     │       │ org_id (FK)     │
        │    │ name            │       │ name            │
        │    │ code            │       │ rotation_pattern│
        │    │ start_time      │       │ created_at      │
        │    │ end_time        │       └─────────────────┘
        │    │ break_duration  │               │
        │    │ color           │               ▼
        │    │ type            │       ┌─────────────────┐
        │    │ created_at      │       │ShiftGroupMember │
        │    └─────────────────┘       ├─────────────────┤
        │            │                 │ group_id (FK)   │
        │            │                 │ employee_id(FK) │
        │            ▼                 │ role            │
        │    ┌─────────────────┐       │ created_at      │
        │    │    Schedule     │       └─────────────────┘
        │    ├─────────────────┤
        │    │ id              │
        │    │ org_id (FK)     │
        │    │ dept_id (FK)    │
        │    │ start_date      │
        │    │ end_date        │
        │    │ status          │
        │    │ created_by      │
        │    │ published_at    │
        │    │ created_at      │
        │    └─────────────────┘
        │            │
        ▼            ▼
┌─────────────────────────────────────┐
│            Assignment               │
├─────────────────────────────────────┤
│ id                                  │
│ schedule_id (FK)                    │
│ employee_id (FK)                    │
│ shift_template_id (FK)              │
│ date                                │
│ actual_start                        │
│ actual_end                          │
│ status (scheduled/confirmed/absent) │
│ notes                               │
│ created_at                          │
└─────────────────────────────────────┘

┌─────────────────┐       ┌─────────────────┐
│     Demand      │       │   Constraint    │
├─────────────────┤       ├─────────────────┤
│ id              │       │ id              │
│ org_id (FK)     │       │ org_id (FK)     │
│ dept_id (FK)    │       │ name            │
│ position_id(FK) │       │ type            │
│ day_of_week     │       │ category (hard/ │
│ time_range      │       │          soft)  │
│ min_count       │       │ weight          │
│ max_count       │       │ config (JSONB)  │
│ priority        │       │ enabled         │
│ created_at      │       │ created_at      │
└─────────────────┘       └─────────────────┘

┌─────────────────────────────────────┐
│            SwapRequest              │
├─────────────────────────────────────┤
│ id                                  │
│ org_id (FK)                         │
│ requester_id (FK)                   │
│ target_id (FK)                      │
│ original_assignment_id (FK)         │
│ target_assignment_id (FK)           │
│ type (swap/transfer/cancel)         │
│ status (pending/approved/rejected)  │
│ reason                              │
│ approved_by                         │
│ approved_at                         │
│ created_at                          │
└─────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════
                    【派出服务扩展模型】
═══════════════════════════════════════════════════════════════════════

┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│    Customer     │       │  ServiceOrder   │       │  ServiceRecord  │
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ id              │◄──────│ customer_id(FK) │───────│ order_id (FK)   │
│ org_id (FK)     │       │ org_id (FK)     │       │ employee_id(FK) │
│ name            │       │ employee_id(FK) │       │ check_in_time   │
│ phone           │       │ service_type    │       │ check_out_time  │
│ address         │       │ scheduled_date  │       │ check_in_location│
│ location (GPS)  │       │ scheduled_time  │       │ service_items   │
│ preferences     │       │ duration_mins   │       │ photos          │
│ care_level      │       │ status          │       │ customer_sign   │
│ created_at      │       │ notes           │       │ notes           │
└─────────────────┘       │ created_at      │       │ rating          │
                          └─────────────────┘       │ created_at      │
                                                    └─────────────────┘

┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│    CarePlan     │       │ EmployeeService │       │  TravelMatrix   │
├─────────────────┤       │      Area       │       ├─────────────────┤
│ id              │       ├─────────────────┤       │ id              │
│ customer_id(FK) │       │ employee_id(FK) │       │ org_id (FK)     │
│ care_level      │       │ district        │       │ from_location   │
│ frequency       │       │ max_distance_km │       │ to_location     │
│ duration_mins   │       │ preferences     │       │ distance_km     │
│ service_items   │       │ created_at      │       │ travel_mins     │
│ start_date      │       └─────────────────┘       │ updated_at      │
│ end_date        │                                 └─────────────────┘
│ status          │
│ created_at      │
└─────────────────┘

┌─────────────────────────────────────┐
│       CustomerEmployeeHistory       │
├─────────────────────────────────────┤
│ id                                  │
│ customer_id (FK)                    │
│ employee_id (FK)                    │
│ service_count                       │
│ avg_rating                          │
│ last_service_date                   │
│ is_preferred (客户偏好)             │
│ created_at                          │
└─────────────────────────────────────┘
```

### 6.2 核心表结构

#### 6.2.1 员工表 (employees)

```sql
CREATE TABLE employees (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id          UUID NOT NULL REFERENCES organizations(id),
    dept_id         UUID REFERENCES departments(id),
    position_id     UUID REFERENCES positions(id),
    employee_no     VARCHAR(50) NOT NULL,
    name            VARCHAR(100) NOT NULL,
    phone           VARCHAR(20),
    email           VARCHAR(100),
    status          VARCHAR(20) DEFAULT 'active', -- active/inactive/on_leave
    hire_date       DATE,
    preferences     JSONB DEFAULT '{}',  -- 员工偏好设置
    -- preferences 示例:
    -- {
    --   "preferred_shifts": ["早班", "午班"],
    --   "unavailable_days": [0, 6],  // 周日、周六不可用
    --   "max_hours_per_week": 40,
    --   "prefer_consecutive_days": true
    -- }
    created_at      TIMESTAMP DEFAULT NOW(),
    updated_at      TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(org_id, employee_no)
);
```

#### 6.2.2 排班分配表 (assignments)

```sql
CREATE TABLE assignments (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    schedule_id         UUID NOT NULL REFERENCES schedules(id),
    employee_id         UUID NOT NULL REFERENCES employees(id),
    shift_template_id   UUID NOT NULL REFERENCES shift_templates(id),
    date                DATE NOT NULL,
    actual_start_time   TIME,          -- 实际开始时间
    actual_end_time     TIME,          -- 实际结束时间
    status              VARCHAR(20) DEFAULT 'scheduled',
    -- status: scheduled(已排班)/confirmed(已确认)/absent(缺勤)/completed(已完成)
    notes               TEXT,
    created_at          TIMESTAMP DEFAULT NOW(),
    updated_at          TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(employee_id, date, shift_template_id)
);

-- 索引优化
CREATE INDEX idx_assignments_schedule ON assignments(schedule_id);
CREATE INDEX idx_assignments_employee_date ON assignments(employee_id, date);
CREATE INDEX idx_assignments_date ON assignments(date);
```

#### 6.2.3 约束规则表 (constraints)

```sql
CREATE TABLE constraints (
    id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id      UUID NOT NULL REFERENCES organizations(id),
    name        VARCHAR(100) NOT NULL,
    type        VARCHAR(50) NOT NULL,   -- 约束类型标识
    category    VARCHAR(10) NOT NULL,   -- hard/soft
    weight      INT DEFAULT 50,         -- 软约束权重 (1-100)
    config      JSONB NOT NULL,         -- 约束配置
    -- config 示例 (max_hours_per_week):
    -- {
    --   "max_hours": 40,
    --   "include_overtime": false,
    --   "scope": "all"  // all/department/position
    -- }
    enabled     BOOLEAN DEFAULT true,
    created_at  TIMESTAMP DEFAULT NOW(),
    updated_at  TIMESTAMP DEFAULT NOW()
);
```

#### 6.2.4 派出服务扩展表

##### 客户表 (customers)

```sql
CREATE TABLE customers (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id          UUID NOT NULL REFERENCES organizations(id),
    name            VARCHAR(100) NOT NULL,
    phone           VARCHAR(20) NOT NULL,
    address         TEXT NOT NULL,
    district        VARCHAR(50),            -- 所在区域
    latitude        DECIMAL(10, 8),         -- GPS纬度
    longitude       DECIMAL(11, 8),         -- GPS经度
    care_level      INT,                    -- 长护险等级 (1-6)，普通客户为NULL
    preferences     JSONB DEFAULT '{}',
    -- preferences 示例:
    -- {
    --   "preferred_employees": ["uuid1", "uuid2"],  // 偏好的服务员
    --   "preferred_time_slots": ["09:00-11:00", "14:00-16:00"],
    --   "special_notes": "家中有宠物",
    --   "language": "方言"
    -- }
    status          VARCHAR(20) DEFAULT 'active',
    created_at      TIMESTAMP DEFAULT NOW(),
    updated_at      TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_customers_org ON customers(org_id);
CREATE INDEX idx_customers_district ON customers(org_id, district);
```

##### 服务订单表 (service_orders)

```sql
CREATE TABLE service_orders (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id              UUID NOT NULL REFERENCES organizations(id),
    customer_id         UUID NOT NULL REFERENCES customers(id),
    employee_id         UUID REFERENCES employees(id),  -- 分配的服务员，可为空（待分配）
    care_plan_id        UUID REFERENCES care_plans(id), -- 长护险关联护理计划
    service_type        VARCHAR(50) NOT NULL,           -- 服务类型
    -- service_type: housekeeping/deep_clean/babysitting/elderly_care/nursing
    scheduled_date      DATE NOT NULL,
    scheduled_start     TIME NOT NULL,
    scheduled_end       TIME NOT NULL,
    duration_mins       INT NOT NULL,
    address             TEXT,                           -- 服务地址（可覆盖客户默认地址）
    status              VARCHAR(20) DEFAULT 'pending',
    -- status: pending/assigned/confirmed/in_progress/completed/cancelled
    source              VARCHAR(20) DEFAULT 'manual',
    -- source: manual/care_plan/recurring/customer_app
    notes               TEXT,
    created_at          TIMESTAMP DEFAULT NOW(),
    updated_at          TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_orders_org_date ON service_orders(org_id, scheduled_date);
CREATE INDEX idx_orders_employee_date ON service_orders(employee_id, scheduled_date);
CREATE INDEX idx_orders_customer ON service_orders(customer_id);
CREATE INDEX idx_orders_status ON service_orders(org_id, status);
```

##### 服务记录表 (service_records)

```sql
CREATE TABLE service_records (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id            UUID NOT NULL REFERENCES service_orders(id),
    employee_id         UUID NOT NULL REFERENCES employees(id),
    check_in_time       TIMESTAMP,
    check_out_time      TIMESTAMP,
    check_in_latitude   DECIMAL(10, 8),
    check_in_longitude  DECIMAL(11, 8),
    check_out_latitude  DECIMAL(10, 8),
    check_out_longitude DECIMAL(11, 8),
    service_items       JSONB,              -- 实际执行的服务项目
    -- service_items 示例:
    -- [
    --   {"code": "BATH", "name": "助浴", "duration_mins": 30, "completed": true},
    --   {"code": "MEAL", "name": "助餐", "duration_mins": 20, "completed": true}
    -- ]
    photos              JSONB,              -- 服务照片 URL 列表
    customer_signature  TEXT,               -- 客户签名（Base64）
    notes               TEXT,
    rating              DECIMAL(2,1),       -- 客户评分 1.0-5.0
    rating_comment      TEXT,               -- 评价内容
    status              VARCHAR(20) DEFAULT 'pending',
    -- status: pending/checked_in/completed/abnormal
    created_at          TIMESTAMP DEFAULT NOW(),
    updated_at          TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_records_order ON service_records(order_id);
CREATE INDEX idx_records_employee ON service_records(employee_id);
```

##### 护理计划表 (care_plans) - 长护险专用

```sql
CREATE TABLE care_plans (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id              UUID NOT NULL REFERENCES organizations(id),
    customer_id         UUID NOT NULL REFERENCES customers(id),
    care_level          INT NOT NULL,           -- 失能等级 1-6
    assessment_date     DATE,                   -- 评估日期
    frequency_per_week  INT NOT NULL,           -- 每周服务次数
    duration_mins       INT NOT NULL,           -- 每次服务时长（分钟）
    service_items       JSONB NOT NULL,         -- 护理服务项目
    -- service_items 示例:
    -- [
    --   {"code": "BATH", "name": "助浴", "frequency": "2/week"},
    --   {"code": "VITAL", "name": "生命体征监测", "frequency": "daily"}
    -- ]
    preferred_time      TIME,                   -- 偏好服务时间
    preferred_days      JSONB,                  -- 偏好服务日 [1,3,5] = 周一三五
    assigned_employee   UUID REFERENCES employees(id),  -- 固定护理员
    start_date          DATE NOT NULL,
    end_date            DATE,                   -- 为空表示长期有效
    status              VARCHAR(20) DEFAULT 'active',
    -- status: active/suspended/terminated
    notes               TEXT,
    created_at          TIMESTAMP DEFAULT NOW(),
    updated_at          TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_care_plans_customer ON care_plans(customer_id);
CREATE INDEX idx_care_plans_status ON care_plans(org_id, status);
```

##### 员工服务区域表 (employee_service_areas)

```sql
CREATE TABLE employee_service_areas (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    employee_id     UUID NOT NULL REFERENCES employees(id),
    district        VARCHAR(50) NOT NULL,       -- 服务区域名称
    max_distance_km DECIMAL(5,2) DEFAULT 15.0,  -- 最大服务距离
    priority        INT DEFAULT 1,              -- 优先级（用于多区域时）
    created_at      TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(employee_id, district)
);

CREATE INDEX idx_service_areas_employee ON employee_service_areas(employee_id);
CREATE INDEX idx_service_areas_district ON employee_service_areas(district);
```

##### 客户-员工服务历史表 (customer_employee_history)

```sql
CREATE TABLE customer_employee_history (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    customer_id         UUID NOT NULL REFERENCES customers(id),
    employee_id         UUID NOT NULL REFERENCES employees(id),
    service_count       INT DEFAULT 0,
    total_duration_mins INT DEFAULT 0,
    avg_rating          DECIMAL(2,1),
    last_service_date   DATE,
    is_preferred        BOOLEAN DEFAULT false,  -- 客户是否标记为偏好
    is_blocked          BOOLEAN DEFAULT false,  -- 客户是否拉黑该员工
    created_at          TIMESTAMP DEFAULT NOW(),
    updated_at          TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(customer_id, employee_id)
);

CREATE INDEX idx_history_customer ON customer_employee_history(customer_id);
CREATE INDEX idx_history_employee ON customer_employee_history(employee_id);
```

---

## 7. 约束系统设计

### 7.1 约束分类

```
┌─────────────────────────────────────────────────────────────────────┐
│                          约束系统架构                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   硬约束 (Hard Constraints)            软约束 (Soft Constraints)    │
│   ━━━━━━━━━━━━━━━━━━━━━━━━━━           ━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│   必须满足，违反则方案无效             尽量满足，违反产生惩罚分数    │
│                                                                     │
│   ┌─────────────────────┐              ┌─────────────────────┐      │
│   │ 法规类约束          │              │ 偏好类约束          │      │
│   │ • 最大工时限制      │              │ • 员工班次偏好      │      │
│   │ • 最小休息间隔      │              │ • 避免连续夜班      │      │
│   │ • 未成年工保护      │              │ • 休息日偏好        │      │
│   └─────────────────────┘              └─────────────────────┘      │
│                                                                     │
│   ┌─────────────────────┐              ┌─────────────────────┐      │
│   │ 资质类约束          │              │ 公平类约束          │      │
│   │ • 岗位技能要求      │              │ • 工时均衡          │      │
│   │ • 证书有效期        │              │ • 好班/坏班均衡     │      │
│   │ • 护理员等级要求    │              │ • 加班均衡          │      │
│   └─────────────────────┘              └─────────────────────┘      │
│                                                                     │
│   ┌─────────────────────┐              ┌─────────────────────┐      │
│   │ 覆盖类约束          │              │ 效率类约束          │      │
│   │ • 最少人数保障      │              │ • 最小化加班        │      │
│   │ • 关键岗位必须在岗  │              │ • 最小化人力成本    │      │
│   │ • 护理计划执行      │              │ • 避免碎片班次      │      │
│   └─────────────────────┘              └─────────────────────┘      │
│                                                                     │
│   ┌─────────────────────┐              ┌─────────────────────┐      │
│   │ 派出服务约束 (硬)   │              │ 派出服务约束 (软)   │      │
│   │ • 服务区域匹配      │              │ • 客户偏好匹配      │      │
│   │ • 路程时间缓冲      │              │ • 护理员连续性      │      │
│   │ • 每日最大订单数    │              │ • 服务时间规律性    │      │
│   │ • 客户黑名单        │              │ • 最小化路程距离    │      │
│   └─────────────────────┘              └─────────────────────┘      │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 7.2 约束接口设计

```go
// pkg/scheduler/constraint/constraint.go

// ConstraintCategory 约束类别
type ConstraintCategory string

const (
    Hard ConstraintCategory = "hard" // 硬约束
    Soft ConstraintCategory = "soft" // 软约束
)

// ConstraintType 约束类型
type ConstraintType string

const (
    // ========== 通用约束 ==========
    MaxHoursPerDay        ConstraintType = "max_hours_per_day"
    MaxHoursPerWeek       ConstraintType = "max_hours_per_week"
    MinRestBetweenShifts  ConstraintType = "min_rest_between_shifts"
    MaxConsecutiveDays    ConstraintType = "max_consecutive_days"
    SkillRequired         ConstraintType = "skill_required"
    EmployeeUnavailable   ConstraintType = "employee_unavailable"
    MinStaffCount         ConstraintType = "min_staff_count"
    
    // ========== 餐饮场景约束 ==========
    PeakHoursMinStaff     ConstraintType = "peak_hours_min_staff"
    
    // ========== 工厂场景约束 ==========
    ShiftRotationPattern  ConstraintType = "shift_rotation_pattern"
    MaxConsecutiveNights  ConstraintType = "max_consecutive_night_shifts"
    ProductionLineCoverage ConstraintType = "production_line_coverage"
    
    // ========== 家政服务约束 ==========
    ServiceAreaMatch      ConstraintType = "service_area_match"       // 服务区域匹配
    TravelTimeBuffer      ConstraintType = "travel_time_buffer"       // 路程时间缓冲
    MaxOrdersPerDay       ConstraintType = "max_orders_per_day"       // 每日最大订单数
    CustomerPreference    ConstraintType = "customer_preference"      // 客户偏好匹配
    MinimizeTravelDist    ConstraintType = "minimize_travel_distance" // 最小化路程
    RouteOptimization     ConstraintType = "route_optimization"       // 多订单路线优化
    CustomerBlacklist     ConstraintType = "customer_blacklist"       // 客户黑名单
    
    // ========== 长护险约束 ==========
    CarePlanCompliance    ConstraintType = "care_plan_compliance"     // 护理计划执行
    CertificationLevel    ConstraintType = "certification_level"      // 资质等级匹配
    CaregiverContinuity   ConstraintType = "caregiver_continuity"     // 护理员连续性
    ServiceTimeRegularity ConstraintType = "service_time_regularity"  // 服务时间规律性
    MaxPatientsPerDay     ConstraintType = "max_patients_per_day"     // 每日最大服务人数
    
    // ========== 公平性约束 ==========
    WorkloadBalance       ConstraintType = "workload_balance"
    ShiftTypeBalance      ConstraintType = "shift_type_balance"
    
    // ========== 偏好约束 ==========
    EmployeePreference    ConstraintType = "employee_preference"
)

// Constraint 约束接口
type Constraint interface {
    // 基本信息
    ID() string
    Name() string
    Type() ConstraintType
    Category() ConstraintCategory
    
    // 权重（仅软约束有效）
    Weight() int
    
    // 评估方法
    // 返回: valid=是否满足, penalty=违反程度(0表示完全满足)
    Evaluate(ctx *ScheduleContext) (valid bool, penalty int, details []ViolationDetail)
    
    // 增量评估（用于快速检测单个分配是否违反约束）
    EvaluateAssignment(ctx *ScheduleContext, assignment *Assignment) (valid bool, penalty int)
}

// ViolationDetail 违规详情
type ViolationDetail struct {
    EmployeeID   string
    Date         time.Time
    ShiftID      string
    Message      string
    Severity     int // 严重程度 1-10
}

// ScheduleContext 排班上下文
type ScheduleContext struct {
    Schedule     *Schedule
    Employees    []*Employee
    Shifts       []*ShiftTemplate
    Demands      []*Demand
    Assignments  []*Assignment
    
    // 辅助查询方法
    GetEmployeeAssignments(employeeID string) []*Assignment
    GetDateAssignments(date time.Time) []*Assignment
    GetEmployeeHoursInPeriod(employeeID string, start, end time.Time) float64
}
```

### 7.3 内置约束实现示例

```go
// pkg/scheduler/constraint/max_hours.go

// MaxHoursPerWeekConstraint 每周最大工时约束
type MaxHoursPerWeekConstraint struct {
    id        string
    name      string
    category  ConstraintCategory
    maxHours  float64
    weight    int
}

func NewMaxHoursPerWeekConstraint(config map[string]interface{}) *MaxHoursPerWeekConstraint {
    return &MaxHoursPerWeekConstraint{
        id:       uuid.New().String(),
        name:     "每周最大工时限制",
        category: Hard, // 硬约束
        maxHours: config["max_hours"].(float64),
        weight:   100,
    }
}

func (c *MaxHoursPerWeekConstraint) Evaluate(ctx *ScheduleContext) (bool, int, []ViolationDetail) {
    var violations []ViolationDetail
    totalPenalty := 0
    allValid := true
    
    for _, emp := range ctx.Employees {
        hours := ctx.GetEmployeeHoursInPeriod(
            emp.ID,
            ctx.Schedule.StartDate,
            ctx.Schedule.EndDate,
        )
        
        if hours > c.maxHours {
            allValid = false
            excess := hours - c.maxHours
            penalty := int(excess * 10) // 每超1小时扣10分
            totalPenalty += penalty
            
            violations = append(violations, ViolationDetail{
                EmployeeID: emp.ID,
                Message:    fmt.Sprintf("员工 %s 周工时 %.1f 超出限制 %.1f", emp.Name, hours, c.maxHours),
                Severity:   min(10, int(excess)),
            })
        }
    }
    
    return allValid, totalPenalty, violations
}
```

### 7.4 约束配置示例

```yaml
# configs/constraints/restaurant.yaml
# 餐饮场景约束配置

name: "餐饮门店标准约束"
scenario: "restaurant"

constraints:
  # ========== 硬约束 ==========
  - type: max_hours_per_day
    category: hard
    config:
      max_hours: 10
      
  - type: max_hours_per_week
    category: hard
    config:
      max_hours: 44
      
  - type: min_rest_between_shifts
    category: hard
    config:
      min_hours: 10
      
  - type: max_consecutive_days
    category: hard
    config:
      max_days: 6
      
  - type: skill_required
    category: hard
    config:
      rules:
        - position: "咖啡师"
          required_skills: ["咖啡师证书"]
        - position: "调酒师"
          required_skills: ["调酒师证书"]
          
  - type: min_staff_count
    category: hard
    config:
      rules:
        - position: "收银员"
          min_count: 1
          time_range: "all"
        - position: "服务员"
          min_count: 2
          time_range: "all"
          
  - type: peak_hours_min_staff
    category: hard
    config:
      rules:
        - name: "午高峰"
          time_range: "11:00-13:00"
          position: "服务员"
          min_count: 4
        - name: "晚高峰"
          time_range: "18:00-20:00"
          position: "服务员"
          min_count: 6

  # ========== 软约束 ==========
  - type: employee_preference
    category: soft
    weight: 60
    config:
      respect_shift_preference: true
      respect_day_off_preference: true
      
  - type: workload_balance
    category: soft
    weight: 80
    config:
      tolerance_percent: 10  # 允许10%偏差
      balance_by: "hours"    # hours/shifts/both
      
  - type: shift_type_balance
    category: soft
    weight: 50
    config:
      balance_types: ["早班", "午班", "晚班"]
      period: "month"
```

---

## 8. 排班算法设计

### 8.1 算法概述

排班问题本质上是一个**约束满足问题 (CSP)** 或**组合优化问题**。我们采用**混合算法策略**：

```
┌─────────────────────────────────────────────────────────────────────┐
│                         排班算法流程                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌───────────────┐                                                 │
│   │  输入数据     │                                                 │
│   │  • 员工列表   │                                                 │
│   │  • 班次模板   │                                                 │
│   │  • 需求规则   │                                                 │
│   │  • 约束规则   │                                                 │
│   └───────┬───────┘                                                 │
│           │                                                         │
│           ▼                                                         │
│   ┌───────────────────────────────────────────────────────────┐    │
│   │              Phase 1: 贪心构造初始解                       │    │
│   │                                                           │    │
│   │   for each 时间槽 (按优先级排序):                          │    │
│   │       for each 需求:                                       │    │
│   │           candidates = 筛选可用员工(满足硬约束)             │    │
│   │           ranked = 按软约束评分排序(candidates)            │    │
│   │           分配最优候选人                                    │    │
│   └───────────────────────────────────────────────────────────┘    │
│           │                                                         │
│           ▼                                                         │
│   ┌───────────────────────────────────────────────────────────┐    │
│   │              Phase 2: 局部优化                             │    │
│   │                                                           │    │
│   │   repeat until 无改进 or 达到迭代上限:                      │    │
│   │       尝试交换操作 (两人互换班次)                           │    │
│   │       尝试移动操作 (将班次转给他人)                         │    │
│   │       尝试插入操作 (填补空缺)                               │    │
│   │       if 新方案更优: 接受变更                               │    │
│   └───────────────────────────────────────────────────────────┘    │
│           │                                                         │
│           ▼                                                         │
│   ┌───────────────────────────────────────────────────────────┐    │
│   │              Phase 3: (可选) 元启发式优化                  │    │
│   │                                                           │    │
│   │   使用遗传算法/模拟退火进一步优化                           │    │
│   │   适用于大规模复杂问题                                      │    │
│   └───────────────────────────────────────────────────────────┘    │
│           │                                                         │
│           ▼                                                         │
│   ┌───────────────┐                                                 │
│   │  输出结果     │                                                 │
│   │  • 排班方案   │                                                 │
│   │  • 评分报告   │                                                 │
│   │  • 违规列表   │                                                 │
│   └───────────────┘                                                 │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 8.2 核心算法接口

```go
// pkg/scheduler/solver/solver.go

// Solver 求解器接口
type Solver interface {
    // Solve 执行排班求解
    Solve(ctx context.Context, input *SolverInput) (*SolverOutput, error)
    
    // Name 求解器名称
    Name() string
}

// SolverInput 求解器输入
type SolverInput struct {
    // 基础数据
    Employees    []*Employee
    Shifts       []*ShiftTemplate
    Demands      []*Demand
    Constraints  []Constraint
    
    // 排班范围
    StartDate    time.Time
    EndDate      time.Time
    
    // 已有分配（用于增量排班）
    ExistingAssignments []*Assignment
    
    // 参数配置
    Options      *SolverOptions
}

// SolverOptions 求解器选项
type SolverOptions struct {
    MaxIterations      int           // 最大迭代次数
    TimeLimit          time.Duration // 时间限制
    OptimizationLevel  int           // 优化级别 1-3
    EnableParallel     bool          // 启用并行计算
    RandomSeed         int64         // 随机种子（用于可重现）
}

// SolverOutput 求解器输出
type SolverOutput struct {
    Assignments    []*Assignment
    Score          *ScheduleScore
    Violations     []ViolationDetail
    Statistics     *SolveStatistics
    Success        bool
    Message        string
}

// ScheduleScore 排班评分
type ScheduleScore struct {
    TotalScore          int     // 总分
    HardConstraintScore int     // 硬约束得分（0表示全满足）
    SoftConstraintScore int     // 软约束得分
    FairnessScore       int     // 公平性得分
    CoverageScore       int     // 覆盖率得分
    Details             map[string]int // 各约束得分明细
}
```

### 8.3 贪心构造算法

```go
// pkg/scheduler/solver/greedy.go

type GreedySolver struct {
    constraints []Constraint
}

func (s *GreedySolver) Solve(ctx context.Context, input *SolverInput) (*SolverOutput, error) {
    assignments := make([]*Assignment, 0)
    scheduleCtx := NewScheduleContext(input)
    
    // 按日期遍历
    for date := input.StartDate; !date.After(input.EndDate); date = date.AddDate(0, 0, 1) {
        // 获取当天需求，按优先级排序
        demands := s.getDemandsForDate(input.Demands, date)
        sort.Slice(demands, func(i, j int) bool {
            return demands[i].Priority > demands[j].Priority
        })
        
        for _, demand := range demands {
            // 获取可用候选人
            candidates := s.getAvailableCandidates(scheduleCtx, date, demand)
            
            // 按软约束评分排序
            ranked := s.rankCandidates(scheduleCtx, candidates, date, demand)
            
            // 分配所需人数
            for i := 0; i < demand.MinCount && i < len(ranked); i++ {
                assignment := &Assignment{
                    EmployeeID:      ranked[i].ID,
                    ShiftTemplateID: demand.ShiftID,
                    Date:            date,
                    Status:          "scheduled",
                }
                assignments = append(assignments, assignment)
                scheduleCtx.AddAssignment(assignment)
            }
        }
    }
    
    // 计算最终评分
    score := s.evaluateSchedule(scheduleCtx)
    violations := s.collectViolations(scheduleCtx)
    
    return &SolverOutput{
        Assignments: assignments,
        Score:       score,
        Violations:  violations,
        Success:     score.HardConstraintScore == 0,
    }, nil
}

// getAvailableCandidates 获取满足硬约束的候选人
func (s *GreedySolver) getAvailableCandidates(
    ctx *ScheduleContext, 
    date time.Time, 
    demand *Demand,
) []*Employee {
    candidates := make([]*Employee, 0)
    
    for _, emp := range ctx.Employees {
        // 检查岗位匹配
        if !s.matchPosition(emp, demand.PositionID) {
            continue
        }
        
        // 检查技能匹配
        if !s.checkSkills(emp, demand.RequiredSkills) {
            continue
        }
        
        // 模拟分配，检查硬约束
        testAssignment := &Assignment{
            EmployeeID:      emp.ID,
            ShiftTemplateID: demand.ShiftID,
            Date:            date,
        }
        
        if s.checkHardConstraints(ctx, testAssignment) {
            candidates = append(candidates, emp)
        }
    }
    
    return candidates
}

// rankCandidates 根据软约束评分对候选人排序
func (s *GreedySolver) rankCandidates(
    ctx *ScheduleContext,
    candidates []*Employee,
    date time.Time,
    demand *Demand,
) []*Employee {
    type scored struct {
        employee *Employee
        score    int
    }
    
    scoredCandidates := make([]scored, 0, len(candidates))
    
    for _, emp := range candidates {
        score := 0
        
        // 偏好匹配加分
        if emp.PrefersShift(demand.ShiftID) {
            score += 20
        }
        
        // 工时均衡加分（工时少的优先）
        hours := ctx.GetEmployeeHoursInPeriod(emp.ID, ctx.Schedule.StartDate, date)
        avgHours := ctx.GetAverageHoursPerEmployee()
        if hours < avgHours {
            score += 10
        }
        
        // 连续工作天数（适当连续有助于效率）
        consecutive := ctx.GetConsecutiveWorkDays(emp.ID, date)
        if consecutive >= 1 && consecutive <= 4 {
            score += 5
        }
        
        scoredCandidates = append(scoredCandidates, scored{emp, score})
    }
    
    // 按分数降序排序
    sort.Slice(scoredCandidates, func(i, j int) bool {
        return scoredCandidates[i].score > scoredCandidates[j].score
    })
    
    result := make([]*Employee, len(scoredCandidates))
    for i, sc := range scoredCandidates {
        result[i] = sc.employee
    }
    return result
}
```

### 8.4 局部搜索优化

```go
// pkg/scheduler/optimizer/local_search.go

type LocalSearchOptimizer struct {
    maxIterations int
    constraints   []Constraint
}

func (o *LocalSearchOptimizer) Optimize(
    ctx context.Context,
    scheduleCtx *ScheduleContext,
) (*ScheduleContext, bool) {
    improved := false
    currentScore := o.evaluate(scheduleCtx)
    
    for i := 0; i < o.maxIterations; i++ {
        // 尝试各种邻域操作
        neighbors := o.generateNeighbors(scheduleCtx)
        
        for _, neighbor := range neighbors {
            newScore := o.evaluate(neighbor)
            
            // 如果新方案更好，接受
            if o.isBetter(newScore, currentScore) {
                scheduleCtx = neighbor
                currentScore = newScore
                improved = true
                break // 重新开始迭代
            }
        }
        
        // 检查是否达到最优
        if currentScore.TotalScore >= 100 {
            break
        }
    }
    
    return scheduleCtx, improved
}

// generateNeighbors 生成邻域方案
func (o *LocalSearchOptimizer) generateNeighbors(ctx *ScheduleContext) []*ScheduleContext {
    neighbors := make([]*ScheduleContext, 0)
    
    // 1. 交换操作：两个员工互换某天的班次
    swapNeighbors := o.generateSwapNeighbors(ctx)
    neighbors = append(neighbors, swapNeighbors...)
    
    // 2. 移动操作：将某个班次从一个员工转给另一个
    moveNeighbors := o.generateMoveNeighbors(ctx)
    neighbors = append(neighbors, moveNeighbors...)
    
    // 3. 插入操作：为空缺时段分配员工
    insertNeighbors := o.generateInsertNeighbors(ctx)
    neighbors = append(neighbors, insertNeighbors...)
    
    return neighbors
}
```

---

## 9. API 设计

### 9.1 API 概览

PaiBan 作为排班引擎服务，API 设计遵循以下原则：
- **无状态计算**：调用方传入完整数据，引擎返回计算结果
- **可选持久化**：引擎可配置为无状态模式（不存储数据）或有状态模式（缓存配置）

```
┌─────────────────────────────────────────────────────────────────────┐
│                       核心计算 API（无状态）                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   【驻场排班】 /api/v1/schedule                                      │
│   ├── POST /generate        自动生成排班 ⭐                         │
│   ├── POST /validate        校验排班方案                            │
│   ├── POST /optimize        优化已有排班                            │
│   └── POST /check-conflict  检测单个分配冲突                        │
│                                                                     │
│   【派出服务】 /api/v1/dispatch                                      │
│   ├── POST /assign          智能派单 ⭐                             │
│   ├── POST /route           路线优化                                │
│   └── POST /recommend       推荐可用服务员                          │
│                                                                     │
│   【调班评估】 /api/v1/swap                                          │
│   ├── POST /evaluate        评估调班可行性                          │
│   └── POST /recommend       推荐可换班员工                          │
│                                                                     │
│   【约束配置】 /api/v1/constraints                                   │
│   ├── GET  /templates       获取场景约束模板                        │
│   ├── POST /validate        验证约束配置                            │
│   └── GET  /types           获取约束类型列表                        │
│                                                                     │
│   【统计分析】 /api/v1/stats                                         │
│   ├── POST /workload        工作量统计                              │
│   ├── POST /fairness        公平性评估                              │
│   └── POST /coverage        需求覆盖率                              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                      配置管理 API（有状态，可选）                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   /api/v1/tenants           租户配置                                │
│   /api/v1/constraint-sets   约束集管理                              │
│   /api/v1/scenario-templates 场景模板管理                           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 9.2 核心 API 详细设计

#### 9.2.1 排班管理 API

```yaml
# 排班管理 API

# 创建排班表
POST /api/v1/schedules
Request:
  {
    "org_id": "uuid",
    "dept_id": "uuid",
    "start_date": "2026-01-13",
    "end_date": "2026-01-19",
    "name": "第3周排班"
  }
Response:
  {
    "id": "uuid",
    "status": "draft",
    "created_at": "2026-01-11T10:00:00Z"
  }

# 自动生成排班 ⭐
POST /api/v1/schedules/{schedule_id}/generate
Request:
  {
    "options": {
      "optimization_level": 2,      # 1=快速, 2=平衡, 3=最优
      "respect_existing": true,     # 保留已有分配
      "time_limit_seconds": 30
    }
  }
Response:
  {
    "success": true,
    "assignments_count": 156,
    "score": {
      "total": 92,
      "hard_constraints": 100,
      "soft_constraints": 88,
      "fairness": 90,
      "coverage": 95
    },
    "violations": [
      {
        "type": "workload_balance",
        "severity": "warning",
        "message": "员工张三工时偏高 (+12%)",
        "employee_id": "uuid"
      }
    ],
    "statistics": {
      "solve_time_ms": 2340,
      "iterations": 150
    }
  }

# 获取排班表视图
GET /api/v1/schedules/{schedule_id}/view
Query:
  view_type: "week" | "day" | "employee" | "position"
  date: "2026-01-13"
Response:
  {
    "view_type": "week",
    "data": {
      "dates": ["2026-01-13", "2026-01-14", ...],
      "rows": [
        {
          "employee": {"id": "uuid", "name": "张三", "position": "服务员"},
          "cells": [
            {"date": "2026-01-13", "shift": {"id": "uuid", "name": "早班", "color": "#4CAF50"}, "status": "scheduled"},
            {"date": "2026-01-14", "shift": null, "status": "day_off"},
            ...
          ]
        }
      ]
    }
  }

# 发布排班
POST /api/v1/schedules/{schedule_id}/publish
Response:
  {
    "success": true,
    "published_at": "2026-01-11T15:30:00Z",
    "notifications_sent": 45
  }
```

#### 9.2.2 排班分配 API

```yaml
# 排班分配 API

# 批量分配
POST /api/v1/assignments/batch
Request:
  {
    "schedule_id": "uuid",
    "assignments": [
      {"employee_id": "uuid", "shift_template_id": "uuid", "date": "2026-01-13"},
      {"employee_id": "uuid", "shift_template_id": "uuid", "date": "2026-01-13"}
    ]
  }
Response:
  {
    "success": true,
    "created": 2,
    "conflicts": []
  }

# 冲突检测
POST /api/v1/assignments/check-conflicts
Request:
  {
    "employee_id": "uuid",
    "shift_template_id": "uuid",
    "date": "2026-01-15"
  }
Response:
  {
    "has_conflicts": true,
    "conflicts": [
      {
        "type": "min_rest_between_shifts",
        "severity": "error",
        "message": "与前一天晚班间隔不足10小时",
        "related_assignment": {"id": "uuid", "date": "2026-01-14", "shift": "晚班"}
      }
    ]
  }

# 获取可用员工（用于手动排班时的候选人推荐）
GET /api/v1/assignments/available-employees
Query:
  schedule_id: "uuid"
  date: "2026-01-15"
  shift_template_id: "uuid"
  position_id: "uuid"
Response:
  {
    "employees": [
      {
        "id": "uuid",
        "name": "李四",
        "score": 95,
        "reasons": ["符合偏好", "工时均衡"]
      },
      {
        "id": "uuid",
        "name": "王五",
        "score": 80,
        "reasons": ["技能匹配"],
        "warnings": ["本周工时偏高"]
      }
    ]
  }
```

#### 9.2.3 调班 API

```yaml
# 调班管理 API

# 发起调班请求
POST /api/v1/swap-requests
Request:
  {
    "type": "swap",  # swap=互换, transfer=转让, cancel=取消
    "requester_assignment_id": "uuid",
    "target_employee_id": "uuid",       # swap时必填
    "target_assignment_id": "uuid",     # swap时必填
    "reason": "家中有事"
  }
Response:
  {
    "id": "uuid",
    "status": "pending",
    "created_at": "2026-01-11T16:00:00Z"
  }

# 智能推荐可换班员工
GET /api/v1/swap-requests/recommendations
Query:
  assignment_id: "uuid"
Response:
  {
    "recommendations": [
      {
        "employee": {"id": "uuid", "name": "王五"},
        "available_assignments": [
          {"id": "uuid", "date": "2026-01-17", "shift": "早班"}
        ],
        "match_score": 90,
        "reasons": ["岗位相同", "技能匹配", "该员工当天休息"]
      }
    ]
  }

# 审批调班
POST /api/v1/swap-requests/{id}/approve
POST /api/v1/swap-requests/{id}/reject
Request:
  {
    "comment": "同意调换"
  }
```

#### 9.2.4 客户管理 API（派出服务）

```yaml
# 客户管理 API

# 创建客户
POST /api/v1/customers
Request:
  {
    "name": "张大爷",
    "phone": "13800138000",
    "address": "上海市浦东新区陆家嘴路100号",
    "district": "浦东新区",
    "latitude": 31.2397,
    "longitude": 121.4998,
    "care_level": 4,  # 长护险等级，普通客户不填
    "preferences": {
      "preferred_time_slots": ["09:00-11:00"],
      "special_notes": "需要方言沟通"
    }
  }

# 获取客户服务历史
GET /api/v1/customers/{id}/service-history
Response:
  {
    "customer": {"id": "uuid", "name": "张大爷"},
    "total_services": 45,
    "preferred_employees": [
      {"id": "uuid", "name": "李阿姨", "service_count": 30, "avg_rating": 4.8}
    ],
    "recent_services": [
      {"date": "2026-01-10", "service_type": "nursing", "employee": "李阿姨", "rating": 5}
    ]
  }
```

#### 9.2.5 服务订单 API（派出服务）

```yaml
# 服务订单 API

# 创建服务订单
POST /api/v1/service-orders
Request:
  {
    "customer_id": "uuid",
    "service_type": "elderly_care",
    "scheduled_date": "2026-01-15",
    "scheduled_start": "09:00",
    "scheduled_end": "11:00",
    "duration_mins": 120,
    "notes": "需要助浴服务"
  }

# 批量创建订单（从护理计划生成）
POST /api/v1/service-orders/batch-from-care-plan
Request:
  {
    "care_plan_id": "uuid",
    "start_date": "2026-01-13",
    "end_date": "2026-01-19"
  }
Response:
  {
    "created_count": 5,
    "orders": [...]
  }

# 智能派单 ⭐
POST /api/v1/dispatch/auto-assign
Request:
  {
    "order_ids": ["uuid1", "uuid2", "uuid3"],  # 待分配订单
    "options": {
      "respect_preferences": true,    # 尊重客户偏好
      "optimize_route": true,         # 优化路线
      "balance_workload": true        # 均衡工作量
    }
  }
Response:
  {
    "success": true,
    "assignments": [
      {
        "order_id": "uuid1",
        "employee_id": "uuid",
        "employee_name": "李阿姨",
        "score": 95,
        "reasons": ["客户偏好匹配", "距离最近", "技能匹配"]
      }
    ],
    "unassigned": [],  # 无法分配的订单
    "statistics": {
      "avg_travel_distance_km": 5.2,
      "workload_balance_score": 88
    }
  }

# 获取员工当日行程
GET /api/v1/dispatch/employee-schedule
Query:
  employee_id: "uuid"
  date: "2026-01-15"
Response:
  {
    "employee": {"id": "uuid", "name": "李阿姨"},
    "date": "2026-01-15",
    "orders": [
      {
        "order_id": "uuid",
        "customer_name": "张大爷",
        "address": "陆家嘴路100号",
        "time_slot": "09:00-11:00",
        "service_type": "nursing",
        "status": "confirmed"
      },
      {
        "order_id": "uuid",
        "customer_name": "王奶奶",
        "address": "世纪大道200号",
        "time_slot": "14:00-15:30",
        "service_type": "nursing",
        "status": "confirmed"
      }
    ],
    "route": {
      "total_distance_km": 12.5,
      "total_travel_mins": 45,
      "optimized_sequence": [0, 1]  # 订单的最优访问顺序
    },
    "summary": {
      "total_orders": 2,
      "total_service_mins": 210,
      "total_work_mins": 255
    }
  }
```

#### 9.2.6 服务记录 API（打卡核销）

```yaml
# 服务记录/打卡 API

# 服务签到
POST /api/v1/service-records/check-in
Request:
  {
    "order_id": "uuid",
    "latitude": 31.2397,
    "longitude": 121.4998,
    "photo": "base64_encoded_photo"  # 可选：签到照片
  }
Response:
  {
    "record_id": "uuid",
    "check_in_time": "2026-01-15T09:02:30Z",
    "location_valid": true,
    "distance_from_customer_m": 50
  }

# 服务签退
POST /api/v1/service-records/{record_id}/check-out
Request:
  {
    "latitude": 31.2397,
    "longitude": 121.4998,
    "service_items": [
      {"code": "BATH", "name": "助浴", "completed": true, "duration_mins": 40},
      {"code": "VITAL", "name": "生命体征监测", "completed": true, "duration_mins": 15}
    ],
    "photos": ["base64_photo1", "base64_photo2"],
    "customer_signature": "base64_signature",
    "notes": "服务正常完成"
  }

# 获取服务记录详情
GET /api/v1/service-records/{record_id}
Response:
  {
    "id": "uuid",
    "order": {...},
    "employee": {"id": "uuid", "name": "李阿姨"},
    "customer": {"id": "uuid", "name": "张大爷"},
    "check_in_time": "2026-01-15T09:02:30Z",
    "check_out_time": "2026-01-15T11:05:00Z",
    "actual_duration_mins": 122,
    "service_items": [...],
    "photos": [...],
    "rating": 5,
    "rating_comment": "非常满意"
  }
```

#### 9.2.7 护理计划 API（长护险）

```yaml
# 护理计划 API

# 创建护理计划
POST /api/v1/care-plans
Request:
  {
    "customer_id": "uuid",
    "care_level": 4,
    "assessment_date": "2026-01-01",
    "frequency_per_week": 6,
    "duration_mins": 90,
    "service_items": [
      {"code": "BATH", "name": "助浴", "frequency": "3/week"},
      {"code": "CLEAN", "name": "居家清洁", "frequency": "2/week"},
      {"code": "VITAL", "name": "生命体征监测", "frequency": "daily"}
    ],
    "preferred_time": "09:00",
    "preferred_days": [1, 3, 5],  # 周一、三、五
    "assigned_employee": "uuid",  # 固定护理员
    "start_date": "2026-01-13"
  }

# 生成周服务订单
POST /api/v1/care-plans/{id}/generate-orders
Request:
  {
    "week_start": "2026-01-13"
  }
Response:
  {
    "plan_id": "uuid",
    "generated_orders": 6,
    "orders": [
      {"date": "2026-01-13", "time": "09:00", "items": ["助浴", "生命体征监测"]},
      {"date": "2026-01-14", "time": "09:00", "items": ["居家清洁", "生命体征监测"]},
      ...
    ]
  }

# 护理计划执行报告
GET /api/v1/care-plans/{id}/compliance-report
Query:
  month: "2026-01"
Response:
  {
    "plan_id": "uuid",
    "customer": {"id": "uuid", "name": "张大爷"},
    "period": "2026-01",
    "planned_services": 26,
    "completed_services": 24,
    "compliance_rate": 92.3,
    "missed_services": [
      {"date": "2026-01-08", "reason": "护理员请假"},
      {"date": "2026-01-22", "reason": "客户住院"}
    ],
    "caregiver_continuity": {
      "primary_caregiver": "李阿姨",
      "primary_rate": 88,  # 主护理员服务占比
      "backup_caregivers": ["王阿姨", "赵阿姨"]
    }
  }
```

---

## 10. 集成指南

### 10.1 快速接入

PaiBan 排班引擎服务通过 REST API 对外提供服务，调用方只需要：

```
┌─────────────────────────────────────────────────────────────────────┐
│                         接入流程                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   Step 1          Step 2           Step 3           Step 4         │
│  ┌────────┐      ┌────────┐       ┌────────┐       ┌────────┐     │
│  │ 申请   │ ───▶ │ 配置   │ ───▶  │ 调用   │ ───▶  │ 解析   │     │
│  │ API Key│      │ 约束   │       │ 排班API │       │ 结果   │     │
│  └────────┘      └────────┘       └────────┘       └────────┘     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 10.2 核心 API 调用示例

#### 10.2.1 驻场排班（餐饮/工厂）

```bash
# 1. 提交排班请求
curl -X POST "https://api.paiban.com/v1/schedule/generate" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "scenario": "restaurant",
    "date_range": {
      "start": "2026-01-13",
      "end": "2026-01-19"
    },
    "resources": [
      {"id": "emp_001", "name": "张三", "position": "服务员", "skills": ["咖啡师"]},
      {"id": "emp_002", "name": "李四", "position": "服务员", "skills": []},
      {"id": "emp_003", "name": "王五", "position": "厨师", "skills": ["中餐"]}
    ],
    "shifts": [
      {"id": "morning", "name": "早班", "start": "06:00", "end": "14:00"},
      {"id": "afternoon", "name": "午班", "start": "11:00", "end": "19:00"},
      {"id": "evening", "name": "晚班", "start": "14:00", "end": "22:00"}
    ],
    "demands": [
      {"shift": "morning", "position": "服务员", "min_count": 2},
      {"shift": "afternoon", "position": "服务员", "min_count": 3},
      {"shift": "evening", "position": "服务员", "min_count": 2}
    ],
    "constraints": {
      "use_template": "restaurant_default",
      "overrides": {
        "max_hours_per_week": 44
      }
    }
  }'

# 2. 获取排班结果
# Response:
{
  "success": true,
  "schedule_id": "sched_abc123",
  "assignments": [
    {"resource_id": "emp_001", "date": "2026-01-13", "shift_id": "morning"},
    {"resource_id": "emp_002", "date": "2026-01-13", "shift_id": "afternoon"},
    {"resource_id": "emp_001", "date": "2026-01-14", "shift_id": "afternoon"},
    ...
  ],
  "score": {
    "total": 92,
    "hard_constraints": 100,
    "soft_constraints": 88,
    "fairness": 90
  },
  "warnings": [
    {"type": "workload_balance", "message": "员工张三本周工时偏高 (+8%)"}
  ]
}
```

#### 10.2.2 派出服务派单（家政/长护险）

```bash
# 1. 提交派单请求
curl -X POST "https://api.paiban.com/v1/dispatch/assign" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "scenario": "nursing",
    "date": "2026-01-15",
    "orders": [
      {
        "id": "order_001",
        "customer_id": "cust_001",
        "customer_name": "张大爷",
        "address": "浦东新区陆家嘴路100号",
        "latitude": 31.2397,
        "longitude": 121.4998,
        "service_type": "nursing",
        "care_level": 4,
        "time_slot": {"start": "09:00", "end": "11:00"},
        "preferred_employee": "emp_101"
      },
      {
        "id": "order_002",
        "customer_id": "cust_002",
        "customer_name": "王奶奶",
        "address": "浦东新区世纪大道200号",
        "latitude": 31.2294,
        "longitude": 121.5245,
        "service_type": "nursing",
        "care_level": 3,
        "time_slot": {"start": "14:00", "end": "15:30"}
      }
    ],
    "employees": [
      {
        "id": "emp_101",
        "name": "李阿姨",
        "certifications": ["高级护理员证"],
        "home_location": {"latitude": 31.2350, "longitude": 121.5100},
        "service_area": ["浦东新区"]
      },
      {
        "id": "emp_102",
        "name": "王阿姨",
        "certifications": ["中级护理员证"],
        "home_location": {"latitude": 31.2200, "longitude": 121.5300},
        "service_area": ["浦东新区"]
      }
    ],
    "options": {
      "prefer_familiar": true,
      "optimize_route": true,
      "balance_workload": true
    }
  }'

# 2. 获取派单结果
# Response:
{
  "success": true,
  "assignments": [
    {
      "order_id": "order_001",
      "employee_id": "emp_101",
      "employee_name": "李阿姨",
      "score": 95,
      "match_reasons": ["客户偏好匹配", "资质满足", "距离最近"]
    },
    {
      "order_id": "order_002",
      "employee_id": "emp_102",
      "employee_name": "王阿姨",
      "score": 88,
      "match_reasons": ["资质满足", "服务区域匹配"]
    }
  ],
  "routes": [
    {
      "employee_id": "emp_101",
      "sequence": ["home", "order_001"],
      "total_distance_km": 3.2,
      "total_travel_mins": 15
    },
    {
      "employee_id": "emp_102",
      "sequence": ["home", "order_002"],
      "total_distance_km": 4.1,
      "total_travel_mins": 18
    }
  ],
  "unassigned": [],
  "statistics": {
    "total_orders": 2,
    "assigned_orders": 2,
    "avg_match_score": 91.5
  }
}
```

### 10.3 场景配置

调用方可以使用内置场景模板，或自定义约束配置：

#### 内置场景模板

| 场景 | 模板标识 | 描述 |
|------|----------|------|
| 餐饮 | `restaurant_default` | 波峰波谷、高峰人数、工时限制 |
| 工厂 | `factory_default` | 三班倒、产线覆盖、资质匹配 |
| 家政 | `housekeeping_default` | 订单派单、路线优化、客户偏好 |
| 长护险 | `nursing_default` | 护理计划、资质等级、护理员连续性 |

#### 自定义约束

```json
{
  "constraints": {
    "hard": [
      {"type": "max_hours_per_day", "value": 10},
      {"type": "min_rest_between_shifts", "value": 10},
      {"type": "skill_required", "rules": [...]}
    ],
    "soft": [
      {"type": "workload_balance", "weight": 80},
      {"type": "employee_preference", "weight": 60}
    ]
  }
}
```

### 10.4 认证与安全

| 项目 | 说明 |
|------|------|
| **认证方式** | Bearer Token（API Key） |
| **HTTPS** | 强制使用 HTTPS |
| **限流** | 默认 100 QPS，可申请提升 |
| **数据隔离** | 按 API Key 隔离，数据不互通 |

### 10.5 错误处理

```json
// 错误响应格式
{
  "success": false,
  "error": {
    "code": "CONSTRAINT_UNSATISFIABLE",
    "message": "无法生成满足所有硬约束的排班方案",
    "details": [
      {"constraint": "min_staff_count", "message": "周三早班服务员不足，需要3人，仅有2人可用"}
    ]
  },
  "suggestions": [
    "增加周三可用的服务员",
    "降低周三早班的最低人数要求"
  ]
}
```

---

## 11. 实现路线图

### 11.1 里程碑规划

```
┌─────────────────────────────────────────────────────────────────────┐
│                          项目里程碑                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Phase 1: MVP (4周)                                                 │
│  ━━━━━━━━━━━━━━━━━━━━                                               │
│  Week 1: 项目初始化 + 基础数据模型                                   │
│    • 项目结构搭建                                                    │
│    • 数据库设计与迁移                                                │
│    • 基础 CRUD API                                                  │
│                                                                     │
│  Week 2: 排班核心引擎                                                │
│    • 约束系统框架                                                    │
│    • 贪心排班算法                                                    │
│    • 基础约束实现（工时、休息间隔）                                   │
│                                                                     │
│  Week 3: API 服务完善                                                │
│    • 排班生成 API                                                    │
│    • 冲突检测 API                                                    │
│    • OpenAPI 文档生成                                                │
│                                                                     │
│  Week 4: 测试 + 优化                                                 │
│    • 单元测试                                                        │
│    • 性能优化                                                        │
│    • MVP 演示                                                        │
│                                                                     │
│  ────────────────────────────────────────────────────────────────   │
│                                                                     │
│  Phase 2: 约束与场景 (4周)                                           │
│  ━━━━━━━━━━━━━━━━━━━━━━━                                            │
│  Week 5-6: 完善约束系统                                              │
│    • 全部内置约束实现（20+种）                                       │
│    • 约束配置模板（YAML）                                            │
│    • 四大场景适配器                                                  │
│                                                                     │
│  Week 7-8: 冲突检测 + 调班                                           │
│    • 实时冲突检测 API                                                │
│    • 调班可行性评估 API                                              │
│    • 推荐可换班员工 API                                              │
│                                                                     │
│  ────────────────────────────────────────────────────────────────   │
│                                                                     │
│  Phase 3: 优化增强 (4周)                                             │
│  ━━━━━━━━━━━━━━━━━━━━━━━                                            │
│  Week 9-10: 算法优化                                                 │
│    • 局部搜索优化器                                                  │
│    • 元启发式算法（可选）                                            │
│    • 大规模测试                                                      │
│                                                                     │
│  Week 11-12: 统计报表 + 通知                                         │
│    • 工时统计                                                        │
│    • 公平性分析                                                      │
│    • 消息通知集成                                                    │
│                                                                     │
│  ────────────────────────────────────────────────────────────────   │
│                                                                     │
│  Phase 4: 派出服务模块 (4周) ⭐ 家政/长护险                           │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━                                      │
│  Week 13-14: 派出服务基础                                            │
│    • 客户管理模块                                                    │
│    • 服务订单模块                                                    │
│    • 派出服务约束实现                                                │
│                                                                     │
│  Week 15-16: 智能派单 + 长护险                                       │
│    • 智能派单算法（技能/距离/偏好匹配）                              │
│    • 护理计划管理                                                    │
│    • 服务打卡核销                                                    │
│    • 路线优化                                                        │
│                                                                     │
│  ────────────────────────────────────────────────────────────────   │
│                                                                     │
│  Phase 5: 生产就绪 (2周)                                             │
│  ━━━━━━━━━━━━━━━━━━━━━━                                             │
│  Week 17-18:                                                        │
│    • 多租户支持                                                      │
│    • 安全加固                                                        │
│    • 部署文档                                                        │
│    • 上线准备                                                        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 11.2 Phase 1 详细任务

```
Week 1: 项目初始化 + 基础数据模型
────────────────────────────────────
□ 创建项目结构
  ├── cmd/server/main.go
  ├── internal/
  ├── pkg/scheduler/
  └── ...
  
□ 数据库设计
  ├── organizations 表
  ├── departments 表
  ├── employees 表
  ├── positions 表
  ├── skills 表
  ├── shift_templates 表
  ├── schedules 表
  ├── assignments 表
  └── constraints 表

□ 基础 CRUD API
  ├── 组织管理 API
  ├── 员工管理 API
  ├── 班次模板 API
  └── ...

Week 2: 排班核心引擎
────────────────────────────────────
□ 约束系统框架
  ├── Constraint 接口定义
  ├── ConstraintManager
  └── ScheduleContext

□ 内置约束实现
  ├── MaxHoursPerDay
  ├── MaxHoursPerWeek
  ├── MinRestBetweenShifts
  ├── MaxConsecutiveDays
  └── SkillRequired

□ 贪心排班算法
  ├── GreedySolver
  ├── 候选人筛选
  └── 候选人排序

Week 3: 排班 API + 简单前端
────────────────────────────────────
□ 排班 API
  ├── POST /schedules
  ├── POST /schedules/{id}/generate
  ├── GET /schedules/{id}/view
  └── POST /schedules/{id}/publish

□ 前端页面
  ├── 排班日历视图
  ├── 员工列表视图
  └── 自动排班触发

Week 4: 测试 + 优化
────────────────────────────────────
□ 测试
  ├── 约束单元测试
  ├── 算法正确性测试
  └── API 集成测试

□ 优化
  ├── 性能基准测试
  ├── 内存优化
  └── 并发处理
```

---

## 附录

### A. 术语表

| 术语 | 英文 | 定义 |
|------|------|------|
| 排班 | Schedule/Scheduling | 为员工分配工作时间段的过程 |
| 班次 | Shift | 一个工作时间段（如早班 8:00-16:00） |
| 班组 | Shift Group | 一组一起轮换的员工 |
| 倒班 | Shift Rotation | 班次的周期性轮换（如三班倒） |
| 硬约束 | Hard Constraint | 必须满足的规则 |
| 软约束 | Soft Constraint | 尽量满足的规则 |
| 调班 | Shift Swap | 员工之间交换班次 |
| 顶班 | Cover Shift | 临时替代他人的班次 |
| **【派出服务术语】** | | |
| 派出服务 | Field Service | 员工外派到客户处提供服务的模式 |
| 服务订单 | Service Order | 客户预约的服务请求 |
| 派单 | Dispatch | 将服务订单分配给服务人员的过程 |
| 护理计划 | Care Plan | 长护险按评估等级制定的服务计划 |
| 失能等级 | Care Level | 长护险老人的失能程度评估（1-6级） |
| 服务区域 | Service Area | 服务人员可覆盖的地理范围 |
| 打卡核销 | Check-in/Check-out | 服务签到签退，用于记录和核销 |
| 护理员连续性 | Caregiver Continuity | 尽量为老人安排固定护理员 |

### B. 参考资料

1. **算法参考**
   - 《约束满足问题》- 人工智能经典教材
   - 《组合优化算法》- 运筹学基础
   - 《车辆路径问题(VRP)》- 派出服务路线优化
   
2. **行业标准**
   - 《劳动法》工时相关规定
   - 《企业职工带薪年休假实施办法》
   - 《长期护理保险制度试点方案》
   - 《家政服务业规范》

3. **开源项目参考**
   - OptaPlanner (Java) - 约束求解引擎
   - or-tools (Google) - 运筹学工具库
   - VROOM (C++) - 车辆路径优化

---

> **文档版本历史**
> 
> | 版本 | 日期 | 作者 | 说明 |
> |------|------|------|------|
> | v1.0 | 2026-01-11 | AI | 初始版本 |
> | v1.1 | 2026-01-11 | AI | 增加家政服务和长护险场景 |
> | v1.2 | 2026-01-11 | AI | 重新定位为独立排班引擎服务，增加集成指南 |

